# Story 1.5: Create Infrastructure as Code (IaC)

**Status:** Draft

---

## Story

**As a** platform engineer,  
**I want** to define all required AWS resources for the refactored system using Infrastructure as Code,  
**so that** environments can be reproduced consistently and audited for configuration drift.

---

## Acceptance Criteria

**Functional Requirements**
1. Terraform or CloudFormation stack (select one primary tool) provisions all infrastructure delivered in Epic 1: ECR repository, Secrets Manager secrets, CloudWatch log group, metric filters, dashboard, and alarms.
2. IaC includes parameterization for environment (`dev`, `staging`, `prod`), AWS account ID, and region (`ap-northeast-2` default), supporting reuse across environments.
3. State management strategy documented (Terraform remote backend or CloudFormation stack naming), with secure storage (e.g., S3 + DynamoDB locking) and instructions to initialize.
4. `infrastructure/README.md` explains how to run `plan`/`apply`, required IAM permissions, and rollback procedure.
5. CI pipeline definition (GitHub Actions, CodeBuild, etc.) skeleton added under `infrastructure/pipeline/` or `.github/workflows/` to lint and plan the IaC on pull requests, storing artifacts for review.
6. Secrets values handled via secure mechanisms (e.g., Terraform `var.secrets` retrieved from external files, not committed); repository contains only placeholders and instructs operators to supply real values at deploy time.

**Integration Requirements**
7. IaC outputs required ARNs/values (ECR repository URI, secrets ARNs, log group name) that downstream stories consume; outputs captured in `VALIDATION.md` or exported to shared config file.
8. Story 1.1â€“1.4 resources reference IaC modules instead of ad-hoc scripts once this story completes (migration plan documented).
9. Local bootstrap script (`scripts/deploy_infra.sh`) wraps IaC commands for developers, ensuring consistent provider versions and handling workspace selection.

**Quality Requirements**
10. IaC linting/validation tools (`terraform fmt`/`terraform validate`, `cfn-lint`, or equivalent) run clean; evidence recorded.
11. Security review confirms least-privilege IAM policies within templates (no wildcard `*` unless justified); review notes stored in `docs/qa/infra-checklist.md`.
12. Successful test deployment to a sandbox AWS account demonstrated and destroyed afterward, with timestamps and resource IDs noted in `VALIDATION.md`.

---

## Tasks / Subtasks

- [ ] Choose IaC tool and scaffold project (AC: 1, 2, 3)
  - [ ] Configure backend/state storage
  - [ ] Define modules or stacks
- [ ] Encode infrastructure resources (AC: 1, 7, 8)
  - [ ] ECR module
  - [ ] Secrets Manager module
  - [ ] CloudWatch logging/alarms module
- [ ] Document workflows (AC: 4, 6, 9)
  - [ ] Write README and runbooks
  - [ ] Add deployment scripts
- [ ] Establish CI checks (AC: 5, 10, 11)
  - [ ] Create pipeline workflow
  - [ ] Capture security review
- [ ] Execute sandbox deployment (AC: 12)
  - [ ] Deploy to test account
  - [ ] Record outputs and teardown

---

## Dev Notes

- **References:**  
  - PRD requirement for reproducible infrastructure (`docs/prd.md:151, 270`).  
  - Architecture migration plan Phase 1 deliverables (`docs/brownfield-architecture.md:1400-1425`).  
  - Existing JSON policy files (`infrastructure/lambda-ecr-policy.json`, `infrastructure/lifecycle-policy.json`) should be incorporated into modules.
- **Implementation Tips:**  
  - Structure Terraform with root module + `modules/` per resource; for CloudFormation, use nested stacks.  
  - Use data sources for existing IAM roles when necessary, but prefer to define new roles in IaC to maintain ownership.
- **Testing Guidance:**  
  - Run `terraform plan` or `cfn-lint` in CI with environment variables pointing to sandbox credentials.  
  - Use `infracost` (optional) to estimate ongoing AWS costs and attach to PRs.

---

## Definition of Done

- [ ] IaC templates committed and validated  
- [ ] Documentation/runbooks updated  
- [ ] CI pipeline in place  
- [ ] Sandbox deployment executed and torn down  
- [ ] Evidence captured for audit

---

## Risk and Compatibility Check

- **Primary Risk:** Misconfigured IaC causing production outage or drift.  
  **Mitigation:** Use sandbox deployments, peer reviews, and CI gates before applying to production.

- **Rollback Plan:** Maintain versioned state and use `terraform destroy` / CloudFormation stack deletion to revert; keep manual rollback checklist for emergency.

**Compatibility Verification**
- [x] IaC introduces no runtime behavior changes until applied  
- [x] Supports incremental migration from manually created resources  
- [x] Aligns with downstream epics requiring automated deployments

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Story drafted from Epic 1 requirements | Sarah (PO) |

