# Story 5.3: Setup Parallel Deployment

**Status:** ⛔ **DEPRECATED** - No longer applicable

**Deprecation Reason:** Legacy Lambda is no longer operational. Epic 5 updated to validation-only strategy (see Epic 5 v2.0 changelog). Parallel deployment not feasible without legacy Lambda.

**Replacement:** Story 5.5 (Validate New Lambda Readiness) now handles validation using offline golden datasets instead of parallel execution.

---

## Quick Project Assessment

**Current System Context**
- [x] The legacy EventBridge rule remains the production trigger while the container-based `naverplace_send_inform_v2` rule is provisioned but intentionally disabled until parallel rollout begins (`docs/epics/epic-5-deployment.md:117-128`, `docs/epics/epic-5-deployment.md:219-224`).
- [x] Parallel execution must isolate state so the new Lambda records bookings without mutating the live `sms` table, preventing rollback complexity if discrepancies surface (`docs/epics/epic-5-deployment.md:219-223`, `docs/epics/epic-5-deployment.md:198-200`, `docs/database/dynamodb.md:9-86`).
- [x] Comparison monitoring depends on capturing counts for SMS, DynamoDB writes, and Telegram notifications from both Lambdas to feed the planned dashboard and alarms (`docs/epics/epic-5-deployment.md:130-143`, `docs/epics/epic-5-deployment.md:225-229`).
- [x] Zero-downtime constraints require keeping the legacy Lambda as the sole customer-facing sender while the new function operates in a shadow mode that is easy to disable within five minutes (`docs/prd.md:434-438`, `docs/prd.md:536-543`, `docs/prd.md:615-645`).

**Change Scope**
- [x] Enable the `naver-sms-automation-v2-trigger` EventBridge rule on the 20-minute cadence once readiness checks pass, leaving the legacy trigger untouched and documenting the before/after state (`docs/epics/epic-5-deployment.md:117-128`, `docs/epics/epic-5-deployment.md:219-224`, `docs/epics/epic-5-deployment.md:260-265`).
- [x] Route the v2 Lambda to a dedicated DynamoDB table (e.g., `sms_v2`) or version-tagged records that mirror the legacy schema so comparison tooling can reconcile outputs without polluting production data (`docs/epics/epic-5-deployment.md:219-223`, `docs/database/dynamodb.md:9-86`).
- [x] Introduce a shadow-mode switch that suppresses real SENS sends from the v2 Lambda while still logging the payloads required for comparison metrics and discrepancy analysis (`docs/prd.md:434-438`, `docs/prd.md:536-543`, `docs/epics/epic-5-deployment.md:130-143`).
- [x] Capture operational runbook updates—including rollback toggles and evidence artifacts—in `VALIDATION.md` to satisfy the Day 0 go/no-go gate (`docs/epics/epic-5-deployment.md:152-169`, `docs/epics/epic-5-deployment.md:260-273`).

---

## Story

**As a** deployment engineer,  
**I want** to run the new container-based Lambda alongside the legacy function in a controlled shadow mode,  
**so that** we can validate parity for one week without disrupting customer SMS delivery before the production cutover.

---

## Story Context

- Epic 5 mandates dual execution with identical booking inputs and segregated tracking so both Lambdas can be compared safely before the cutover decision (`docs/epics/epic-5-deployment.md:219-224`, `docs/prd.md:615-645`).
- Database risk analysis calls for separate storage during the trial to avoid corrupting or duplicating the primary `sms` data set (`docs/epics/epic-5-deployment.md:198-200`, `docs/database/dynamodb.md:9-86`).
- Comparison dashboards and alarms require the new Lambda to surface counts and discrepancy metrics on every run to feed the monitoring plan (`docs/epics/epic-5-deployment.md:130-143`, `docs/epics/epic-5-deployment.md:225-229`, `docs/epics/epic-5-deployment.md:286-303`).
- Rollback procedures rely on being able to disable the new trigger quickly and resume single-Lambda operation with no customer impact (`docs/epics/epic-5-deployment.md:152-169`, `docs/prd.md:434-438`).

---

## Acceptance Criteria

**Functional Requirements**
1. EventBridge rule `naver-sms-automation-v2-trigger` is enabled on the 20-minute schedule, retains the original target ARN, and coexists with the legacy trigger without altering its configuration (`docs/epics/epic-5-deployment.md:117-128`, `docs/epics/epic-5-deployment.md:219-224`).
2. The v2 Lambda writes booking outcomes to an isolated tracking store (new `sms_v2` table or version-tagged items) that mirrors the legacy schema while leaving the production `sms` table untouched (`docs/epics/epic-5-deployment.md:219-223`, `docs/database/dynamodb.md:9-86`).
3. Shadow-mode execution prevents the v2 Lambda from delivering live SENS SMS while logging the would-be payloads for parity analysis, ensuring the legacy Lambda remains the sole source of customer messages (`docs/prd.md:434-438`, `docs/prd.md:536-543`, `docs/epics/epic-5-deployment.md:219-224`).
4. Each invocation emits structured comparison summaries (SMS counts, DynamoDB mutations, Telegram events, discrepancy tallies) to CloudWatch logs and the `naver-sms/comparison/*` metrics namespace required by the monitoring plan (`docs/epics/epic-5-deployment.md:130-143`, `docs/epics/epic-5-deployment.md:225-229`, `docs/epics/epic-5-deployment.md:286-303`).

**Integration Requirements**
5. Comparison tooling can retrieve both legacy (`sms`) and shadow (`sms_v2` or equivalent) datasets with documented access patterns so nightly parity jobs operate without code changes (`docs/epics/epic-5-deployment.md:219-224`, `docs/brownfield-architecture.md:1683-1710`).
6. CloudWatch alarms for discrepancies, match percentage, Lambda errors, and duration are created or updated to watch the new metrics and verified in the console/CLI (`docs/epics/epic-5-deployment.md:286-303`).
7. Operations runbooks and rollback checklists include the precise commands for enabling/disabling both EventBridge rules and restoring single-Lambda mode within the five-minute SLA (`docs/epics/epic-5-deployment.md:152-169`, `docs/prd.md:434-438`).

**Quality Requirements**
8. Evidence for trigger states, DynamoDB tracking configuration, and sample comparison metrics is captured in `VALIDATION.md` (with timestamps and CLI output) to satisfy the epic go/no-go audit trail (`docs/epics/epic-5-deployment.md:260-273`).
9. A dry-run exercise (test invocation or limited window) proves the shadow-mode path avoids real SMS delivery while still producing comparison artifacts, and the results are linked in the story for QA review (`docs/prd.md:536-543`, `docs/prd.md:615-645`).

---

## Tasks / Subtasks

- [ ] Enable `naver-sms-automation-v2-trigger`, record the pre/post `aws events describe-rule` output, and archive it for validation (AC 1, AC 8).
  - [ ] Document the legacy trigger configuration to confirm no changes occurred during activation (AC 1, AC 7, AC 8).
- [ ] Implement the shadow-mode data path that routes v2 Lambda results to `sms_v2` (or version-tagged records) while suppressing real SENS sends (AC 2, AC 3, AC 5).
  - [ ] Provision or update infrastructure-as-code for the new tracking table and update settings/rule-engine wiring accordingly (AC 2, AC 5).
- [ ] Emit comparison summaries and publish the required CloudWatch metrics/alarms, verifying they appear in both logs and metric listings (AC 4, AC 6, AC 8).
  - [ ] Capture screenshots or CLI outputs of alarm states and metric samples for the validation dossier (AC 6, AC 8).
- [ ] Update the deployment runbook and rollback checklist with shadow-mode procedures, including a tested rollback drill (AC 7, AC 9).
  - [ ] Execute and log a rollback dry-run (disable v2 trigger, re-enable legacy-only) confirming the five-minute requirement (AC 7, AC 9).

---

## Dev Notes

- Use the recorded AWS CLI snippets for enabling the v2 EventBridge rule and re-confirm scheduling matches the legacy cadence before saving evidence (`docs/epics/epic-5-deployment.md:117-128`, `docs/epics/epic-5-deployment.md:260-265`).
- Mirror the `sms` schema when creating `sms_v2` so comparison tooling can reuse existing serializers without modification (`docs/database/dynamodb.md:9-86`, `docs/epics/epic-5-deployment.md:219-223`).
- Implement shadow-mode via configuration (e.g., `Settings` flag) that skips SENS calls but still writes structured log entries for comparison diffing (`docs/prd.md:434-438`, `docs/prd.md:536-543`).
- Leverage the monitoring plan’s metric names and alarm thresholds to wire CloudWatch instrumentation consistently (`docs/epics/epic-5-deployment.md:130-143`, `docs/epics/epic-5-deployment.md:286-303`).
- Update `VALIDATION.md` with command transcripts, rollback proof, and links to CloudWatch dashboards to support the Day 0 go/no-go review (`docs/epics/epic-5-deployment.md:260-273`).

### Testing

- Run `aws events describe-rule --name naver-sms-automation-v2-trigger` and `aws events list-targets-by-rule` before and after activation; attach outputs to validation artifacts (AC 1, AC 8).
- Invoke the v2 Lambda in shadow mode (via `aws lambda invoke` or test event) and confirm DynamoDB writes land in `sms_v2` while SENS logs only simulated payloads (AC 2, AC 3, AC 5, AC 9).
- Query CloudWatch metrics (`aws cloudwatch get-metric-statistics`) for `naver-sms/comparison/*` to confirm data points and alarm state transitions (AC 4, AC 6, AC 8).
- Execute the rollback drill (disable v2 trigger, observe only legacy executions) and log elapsed time to demonstrate compliance with the five-minute SLA (AC 7, AC 9).

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-19 | 0.1 | Initial draft created from Epic 5 parallel deployment requirements | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
- Pending assignment

### Debug Log References
- Pending implementation

### Completion Notes
- No development activity recorded yet; update upon implementation.

### File List
- Pending updates

---

## QA Results

### Review Date
- Pending review

### Reviewed By
- Pending assignment

### Summary
- QA evaluation not yet performed; populate after readiness review.

