# Story 3.3: Implement Action Executors

**Status:** Draft

---

## Quick Project Assessment

**Current System Context**
- [x] Legacy actions identified in `original_code/lambda_function.py:140-205, 439-446` and `original_code/sens_sms.py`.
- [x] Technology stack: Python 3.11 Lambda container, DynamoDB repositories (Story 2.3), SENS client (Story 2.2), configuration loader (Story 2.4).
- [x] Integration points: `RuleEngine.execute_rule`, notifications layer, DynamoDB repositories, Telegram/Slack notification services.
- [x] Existing patterns: Async-capable executors registered in rule engine (`docs/brownfield-architecture.md:1140-1165`).

**Change Scope**
- [x] Actions implemented in `src/rules/actions.py` using dependency injection for repositories/services.
- [x] Boundaries: interacts with SMS client, DynamoDB repositories, notification services; no direct HTTP calls elsewhere.
- [x] Success Criteria: parity with legacy side effects (SMS sent, DynamoDB updated, Telegram alerts) validated via regression harness.

---

## Story

**As a** developer,
**I want** to provide rule engine action executors that encapsulate all side effects,
**so that** declarative rules can trigger SMS sends, database updates, and notifications identical to the legacy system.

---

## Story Context

**Existing System Integration:**
- Integrates with: `RuleEngine.execute_rule`, registries in `src/rules/__init__.py`, DynamoDB repositories, notification services.
- Technology: Python async-capable functions (awaited or run via event loop), boto3 DynamoDB client, SENS REST API, Telegram/Slack webhooks.
- Follows pattern: Architecture guidance for action executors (`docs/brownfield-architecture.md:1140-1165`).
- Touch points: `config/rules.yaml`, `src/rules/engine.py`, `src/notifications/sms_service.py`, `src/database/dynamodb_client.py`, `src/notifications/telegram_service.py`, `src/notifications/slack_service.py`.

---

## Acceptance Criteria

**Functional Requirements**
1. Implement executor functions (`send_sms`, `create_db_record`, `update_flag`, `send_telegram`, `send_slack`, `log_event`) in `src/rules/actions.py` that mirror legacy logic, consuming dependencies from the services/repositories created in Epic 2 and masking sensitive data in logs.
2. `send_sms` delegates to the SENS client with parameters derived from rule context (template, store-specific flag) and logs success/failure; behavior matches `send_sms` calls in `original_code/lambda_function.py`.
3. `create_db_record` inserts booking records into DynamoDB with the exact schema used in the legacy flow, including `confirm_sms`, `remind_sms`, and `option_sms` flags, using the BookingRepository.
4. `update_flag` updates a single DynamoDB boolean flag and returns the updated record or success indicator consistent with legacy `update_item`; handles idempotency by short-circuiting when flag already set.
5. `send_telegram` posts messages via Telegram service with identical payload structure (from Story 2.2/2.3 extraction), supporting templated messages from rules; `send_slack` integrates with Slack webhook configuration (no-op if Slack disabled).
6. `log_event` writes structured log entries with metadata (`rule`, `action`, `booking_id`, `status`, `message`) that align with CloudWatch metric filters (Story 1.4).

**Integration Requirements**
7. Action registry helper (`register_actions(engine: RuleEngine, services: ActionServicesBundle)`) registers all executors and is invoked during application bootstrap.
8. Executors accept a shared `ActionContext` dataclass containing booking, settings, repositories, and logger references; unit tests verify immutability and safe reuse.
9. Error handling: executor exceptions are wrapped in `ActionExecutionError` with context; the rule engine logs the failure and continues evaluating remaining actions per AC from Story 3.1.

**Quality Requirements**
10. Unit tests (`tests/rules/test_actions.py`) cover success, failure, and edge cases for each executor using mocks/stubs; asynchronous behavior tested via pytest-asyncio.
11. Integration tests (`tests/integration/test_rule_actions.py`) run against local DynamoDB and stubbed notification services to ensure side effects (DB writes, SMS call, notifications) execute end-to-end.
12. Documentation (`docs/rules/actions.md`) explains each executor, required context keys, and how to add new actions; validation evidence (test results, regression comparisons) appended to `VALIDATION.md`.

---

## Technical Notes

- **Integration Approach:** Use dependency bundle (repositories, sms client, notification services) passed to registry; executors remain pure functions aside from calling injected services.
- **Existing Pattern Reference:** `docs/brownfield-architecture.md:394-465` mapping of legacy actions to new executors.
- **Key Constraints:** Preserve legacy payloads for SENS/Telegram; ensure DynamoDB schema unchanged; maintain logging format for metrics.

---

## Definition of Done

- [ ] Functional requirements satisfied
- [ ] Integration requirements verified
- [ ] Tests and documentation updated
- [ ] Validation evidence recorded

---

## Risk and Compatibility Check

- **Primary Risk:** Divergent side effects (duplicate SMS, missed updates).  
  **Mitigation:** Regression comparison suite, staging dry runs before production cutover.
- **Rollback:** Switch rule engine actions back to legacy helper calls via feature flag.

**Compatibility Verification**
- [x] Works with rule engine core and condition evaluators  
- [x] Aligns with configuration loader and services from Epic 2  
- [x] Supports future actions (Slack extension)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Story created from Epic 3 requirements | Sarah (PO) |

