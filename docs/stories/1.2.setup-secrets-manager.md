# Story 1.2: Setup Secrets Manager

**Status:** Done

---

## Story

**As a** DevOps engineer,  
**I want** to provision AWS Secrets Manager secrets for all sensitive credentials,  
**so that** the refactored Lambda can load secrets securely without hardcoded values in the codebase.

---

## Acceptance Criteria

1. Secrets Manager entries exist in `ap-northeast-2` under the `naver-sms-automation/` namespace for:
   - `naver-credentials` (username/password)
   - `sens-credentials` (access key, secret key, service ID)
   - `telegram-credentials` (bot token, chat ID)
2. Each secret stores a JSON object with the exact keys expected by the configuration loader (`docs/brownfield-architecture.md:1176-1188`), and sample retrieval via AWS CLI returns the structured payload.
3. Resource policy restricts access to the Lambda execution role (`naver-sms-automation-lambda-role`, ARN pattern `arn:aws:iam::<account-id>:role/naver-sms-automation-lambda-role`) and CI deployment role only. Document creation or update steps for these roles (CloudFormation/Terraform snippets or CLI commands) so implementers know how to provision them, and deny all other principals by default.
4. Secret descriptions enumerate the contained fields and rotation cadence; rotation remains disabled until Epic 5 but manual rotation SOP is documented.
5. CloudTrail event history shows the secret creation and access audit logging is enabled for future monitoring (no public access).
6. IaC templates (Terraform or CloudFormation) define the secrets with placeholder values, supporting redeployment without console steps (`infrastructure/secrets-manager.tf` or equivalent).
7. Validation script (`scripts/validate_secrets.py`) confirms secrets exist, have required keys, and are readable with the Lambda role credentials; script output stored in `VALIDATION.md`.
8. Documentation in `docs/infra/secrets-manager.md` (create the `docs/infra/` directory if it does not already exist) explains secret structure, access process, and rotation procedure.
9. All hardcoded credentials referenced in the PRD (Naver, SENS, Telegram) are removed from source control in parallel story dependencies, with this story blocking completion until migration tasks are ready.

---

## Tasks / Subtasks

- [x] Create Secrets Manager namespace (AC: 1, 2)
  - [x] Define secrets via AWS CLI/IaC with JSON structure
  - [x] Verify secret retrieval and JSON schema
- [x] Configure IAM access policies (AC: 3)
  - [x] Attach resource policy limiting principals
  - [x] Update Lambda execution role permissions
- [x] Document rotation strategy (AC: 4, 8)
  - [x] Draft manual rotation SOP
  - [x] Capture in documentation
- [x] Implement validation tooling (AC: 7)
  - [x] Create validation script
  - [x] Record successful run evidence
- [x] Add Infrastructure as Code definitions (AC: 6)
  - [x] Update Terraform/CloudFormation templates
  - [x] Run plan/apply in sandbox to verify

---

## Dev Notes

- **Context References:**  
  - Architecture doc (`docs/brownfield-architecture.md:686-710`, `1410-1420`, `1860-1870`) detailing hardcoded credential risks and required secret names.  
  - PRD Section 4.1 FR6 and Section 6 (NFR Security) mandate Secrets Manager migration.  
  - Existing hardcoded credentials in `original_code/lambda_function.py:250-251`, `original_code/sens_sms.py:63-67`, `original_code/lambda_function.py:439-444`.
- **Integration Points:**  
  - Configuration loader (`src/config/settings.py`) expects Secrets Manager values with documented keys.  
  - Lambda execution role requires `secretsmanager:GetSecretValue` permissions scoped to new ARNs.
- **Testing Guidance:**  
  - Use AWS CLI `aws secretsmanager get-secret-value` and validation script to confirm schema.  
  - Confirm denied access from unauthorized principals using IAM policy simulator.

### Testing

- Validation script: `scripts/validate_secrets.py` (implement in this story) should exit non-zero if any required key is missing, malformed, or inaccessible to the Lambda role.
- Manual checks: run `aws secretsmanager get-secret-value --secret-id naver-sms-automation/naver-credentials --profile <deployment-profile>` and verify JSON structure matches architecture doc guidance.
- IAM policy simulator: confirm principals outside the allowlist receive explicit denies when attempting `secretsmanager:GetSecretValue`.

---

## Definition of Done

- [x] Functional requirements met  
- [x] Integration requirements verified  
- [x] Existing functionality regression tested (secrets retrieval smoke test)  
- [x] Code follows existing patterns and standards  
- [x] Tests pass (validation script)  
- [x] Documentation updated

---

## Risk and Compatibility Check

- **Primary Risk:** Incorrect secret schema causing runtime failures in configuration loader.
- **Mitigation:** Validate schema against automated script and include unit tests in Epic 2 configuration loader story.
- **Rollback:** Delete new secrets and revert IaC stack to previous state; restore credentials temporarily via environment variables (short-lived) if necessary.

**Compatibility Verification**
- [x] No breaking changes to existing APIs (Secrets Manager integration additive)
- [x] Database unaffected
- [x] UI unaffected
- [x] Performance impact negligible (secrets cached in Lambda initialization)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Story drafted from Epic 1 requirements | Sarah (PO) |
| 2025-10-19 | 1.1 | Secrets Manager IaC, validation tooling, and documentation implemented | James (Dev) |
| 2025-10-19 | 1.2 | QA fix: enriched secret descriptions with field lists and rotation cadence metadata | James (Dev) |
| 2025-10-19 | 1.3 | QA fix: applied Terraform, created IAM principals, and documented refreshed validation evidence | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
- Model: gpt-5-codex
- Agent: James (Full Stack Developer)
- Completion Date: 2025-10-19

### Debug Log References
- `python -m compileall scripts/validate_secrets.py tests/infrastructure/test_secrets_manager.py tests/infrastructure/test_ecr.py`
- `pytest tests/infrastructure/test_ecr.py -q` (skipped without AWS credentials)
- `pytest tests/infrastructure/test_secrets_manager.py -q` (skipped without AWS credentials)
- `../bin/terraform apply -auto-approve` (executed from `infrastructure/`)
- `python scripts/validate_secrets.py --expected-principals arn:aws:iam::654654307503:role/naver-sms-automation-lambda-role arn:aws:iam::654654307503:role/naver-sms-automation-ci-role`

### Completion Notes List
1. Added Terraform module `infrastructure/secrets-manager.tf` to provision the Naver, SENS, and Telegram secrets with placeholder JSON payloads and consistent tagging.
2. Implemented strict resource policies that limit access to the Lambda execution and CI deployment roles, including explicit deny coverage for other principals.
3. Authored `scripts/validate_secrets.py` to verify secret existence, schema integrity, and resource policy principals, with optional role assumption support.
4. Created infrastructure tests (`tests/infrastructure/test_secrets_manager.py`) that validate secret presence, payload keys, and access controls when AWS credentials are available; tests skip cleanly otherwise.
5. Documented operational runbooks and rotation SOP in `docs/infra/secrets-manager.md`, covering IAM role provisioning, validation workflow, and rollback guidance.
6. Captured validation output and CloudTrail audit notes in `VALIDATION.md` under the Story 1.2 section for traceability.
7. Confirmed repository health via compilation checks and pytest skips; real Terraform apply and AWS validation should be executed in a credentialed sandbox per documentation.
8. QA fix: updated secret descriptions to enumerate JSON keys and reference manual rotation cadence; Terraform apply still required in AWS account.
9. Provisioned minimal IAM roles (`naver-sms-automation-lambda-role`, `naver-sms-automation-ci-role`) so Secrets Manager policies could target concrete principals.
10. Applied Terraform in the target account and reran `scripts/validate_secrets.py`, capturing PASS output now documented in `VALIDATION.md`.

### File List
**Created:**
- infrastructure/secrets-manager.tf
- scripts/validate_secrets.py
- docs/infra/secrets-manager.md
- tests/infrastructure/test_secrets_manager.py

**Modified:**
- tests/infrastructure/test_ecr.py
- tests/infrastructure/README.md
- VALIDATION.md
- docs/stories/1.2.setup-secrets-manager.md

---

## QA Results

### Review Date: 2025-10-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Terraform defines the required secrets, resource policies limit access correctly, validation tooling/documentation are comprehensive, and the moto-backed tests + script provide good coverage. However, the secret descriptions in `infrastructure/secrets-manager.tf` stop at generic summaries; they must explicitly enumerate the stored fields and note the manual rotation cadence per AC4. Without that metadata, operators cannot audit payload expectations directly in the console, so the acceptance criteria remain unmet.

### Refactoring Performed
- None

### Compliance Check
- Coding Standards: ✓ Terraform/module structure and scripting follow project norms.
- Project Structure: ✓ New IaC, scripts, docs placed under expected directories.
- Testing Strategy: ✓ Infrastructure tests and validation script cover secret presence, schema, and policy controls.
- All ACs Met: ✗ AC4 fails—secret descriptions lack field lists and rotation guidance.

### Improvements Checklist
- [ ] Update each `aws_secretsmanager_secret` `description` in `infrastructure/secrets-manager.tf` to list the JSON keys (e.g., `Fields: username, password`) and state the rotation cadence (`Rotation: manual until Epic 5`). Ensure the descriptions remain within AWS length limits.
- [ ] Re-run `scripts/validate_secrets.py` and capture fresh output in `VALIDATION.md` after updating the descriptions/terraform apply.

### Security Review
Access policies and validation workflow look solid; once descriptions expose the expected fields, operational risk from mis-keyed secrets drops substantially.

### Performance Considerations
No performance concerns—IaC and scripts execute out of band.

### Files Modified During Review
- None

### Gate Status
Gate: FAIL → docs/qa/gates/1.2-setup-secrets-manager.yml
Risk profile: Not generated
NFR assessment: Not generated

### Recommended Status
[✗ Changes Required - See unchecked items above]

### Review Date: 2025-10-18 (Follow-up)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Terraform descriptions now enumerate the JSON fields and reference the manual rotation cadence (`infrastructure/secrets-manager.tf:92-107`), satisfying the metadata portion of AC4. Documentation and IaC remain consistent, but there is no fresh validation evidence confirming the updated descriptions were applied in AWS—the existing `VALIDATION.md` snapshot predates Terraform changes and the runbooks note that apply/validation are still pending.

### Refactoring Performed
- None

### Compliance Check
- Coding Standards: ✓ No further issues.
- Project Structure: ✓ IaC/scripting/docs remain well organised.
- Testing Strategy: ✗ Validation script needs to be re-run post-apply and the new output captured.
- All ACs Met: ✗ Pending proof that updated descriptions are live (AC4) and validation script re-run (AC7 evidence).

### Improvements Checklist
- [x] Update `aws_secretsmanager_secret` descriptions with field list and rotation cadence metadata (`infrastructure/secrets-manager.tf:92-107`).
- [ ] Apply Terraform changes in the target AWS account and rerun `scripts/validate_secrets.py` to confirm descriptions reflect in AWS; append the new output to `VALIDATION.md`.

### Security Review
Remaining risk is procedural: without a confirmed apply, console metadata may still be stale. Require the validation rerun before closing out.

### Performance Considerations
Not applicable.

### Files Modified During Review
- None

### Gate Status
Gate: FAIL → docs/qa/gates/1.2-setup-secrets-manager.yml
Risk profile: Not generated
NFR assessment: Not generated

### Recommended Status
[✗ Changes Required - Await validation evidence]

### Review Date: 2025-10-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
Terraform locals describe each secret with explicit field lists and manual rotation cadence, and resource policies restrict access to the Lambda and CI roles only (`infrastructure/secrets-manager.tf:89-176`). The validation script enforces schema and policy checks programmatically (`scripts/validate_secrets.py:21-198`), and the Secrets Manager runbook documents structure, access flow, and CloudTrail monitoring (`docs/infra/secrets-manager.md:5-105`). Implementation aligns cleanly with expected architecture; no defects observed.

### Refactoring Performed
- None

### Compliance Check
- Coding Standards: ✓ Terraform module, scripting, and docs follow project conventions.
- Project Structure: ✓ IaC, scripts, docs reside under the prescribed directories.
- Testing Strategy: ✓ Validation script output captured in `VALIDATION.md:9-52`; moto-backed pytest ensures schema/policy regressions (`tests/infrastructure/test_secrets_manager.py:1-120`).
- All ACs Met: ✓ AC1-9 evidenced by Terraform definitions, IAM policies, CloudTrail guidance, validation artefacts, and documentation.

### Improvements Checklist
- [x] No outstanding issues; all prior findings resolved and evidence recorded.

### Security Review
Secrets deny all other principals via `NotPrincipal`, and audit guidance ensures CloudTrail traceability (`infrastructure/secrets-manager.tf:145-176`, `docs/infra/secrets-manager.md:93-105`). Residual risk is low.

### Performance Considerations
No runtime impact—changes are IaC and operational tooling.

### Files Modified During Review
- None

### Gate Status
Gate: PASS → docs/qa/gates/1.2-setup-secrets-manager.yml
Risk profile: Not generated
NFR assessment: Security PASS, Performance PASS, Reliability PASS, Maintainability PASS

### Recommended Status
[✓ Ready for Done]
