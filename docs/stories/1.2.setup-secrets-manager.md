# Story 1.2: Setup Secrets Manager

**Status:** Draft

---

## Story

**As a** DevOps engineer,  
**I want** to provision AWS Secrets Manager secrets for all sensitive credentials,  
**so that** the refactored Lambda can load secrets securely without hardcoded values in the codebase.

---

## Acceptance Criteria

1. Secrets Manager entries exist in `ap-northeast-2` under the `naver-sms-automation/` namespace for:
   - `naver-credentials` (username/password)
   - `sens-credentials` (access key, secret key, service ID)
   - `telegram-credentials` (bot token, chat ID)
2. Each secret stores a JSON object with the exact keys expected by the configuration loader (`docs/brownfield-architecture.md:1176-1188`), and sample retrieval via AWS CLI returns the structured payload.
3. Resource policy restricts access to the Lambda execution role (`naver-sms-automation-lambda-role`, ARN pattern `arn:aws:iam::<account-id>:role/naver-sms-automation-lambda-role`) and CI deployment role only. Document creation or update steps for these roles (CloudFormation/Terraform snippets or CLI commands) so implementers know how to provision them, and deny all other principals by default.
4. Secret descriptions enumerate the contained fields and rotation cadence; rotation remains disabled until Epic 5 but manual rotation SOP is documented.
5. CloudTrail event history shows the secret creation and access audit logging is enabled for future monitoring (no public access).
6. IaC templates (Terraform or CloudFormation) define the secrets with placeholder values, supporting redeployment without console steps (`infrastructure/secrets-manager.tf` or equivalent).
7. Validation script (`scripts/validate_secrets.py`) confirms secrets exist, have required keys, and are readable with the Lambda role credentials; script output stored in `VALIDATION.md`.
8. Documentation in `docs/infra/secrets-manager.md` (create the `docs/infra/` directory if it does not already exist) explains secret structure, access process, and rotation procedure.
9. All hardcoded credentials referenced in the PRD (Naver, SENS, Telegram) are removed from source control in parallel story dependencies, with this story blocking completion until migration tasks are ready.

---

## Tasks / Subtasks

- [ ] Create Secrets Manager namespace (AC: 1, 2)
  - [ ] Define secrets via AWS CLI/IaC with JSON structure
  - [ ] Verify secret retrieval and JSON schema
- [ ] Configure IAM access policies (AC: 3)
  - [ ] Attach resource policy limiting principals
  - [ ] Update Lambda execution role permissions
- [ ] Document rotation strategy (AC: 4, 8)
  - [ ] Draft manual rotation SOP
  - [ ] Capture in documentation
- [ ] Implement validation tooling (AC: 7)
  - [ ] Create validation script
  - [ ] Record successful run evidence
- [ ] Add Infrastructure as Code definitions (AC: 6)
  - [ ] Update Terraform/CloudFormation templates
  - [ ] Run plan/apply in sandbox to verify

---

## Dev Notes

- **Context References:**  
  - Architecture doc (`docs/brownfield-architecture.md:686-710`, `1410-1420`, `1860-1870`) detailing hardcoded credential risks and required secret names.  
  - PRD Section 4.1 FR6 and Section 6 (NFR Security) mandate Secrets Manager migration.  
  - Existing hardcoded credentials in `original_code/lambda_function.py:250-251`, `original_code/sens_sms.py:63-67`, `original_code/lambda_function.py:439-444`.
- **Integration Points:**  
  - Configuration loader (`src/config/settings.py`) expects Secrets Manager values with documented keys.  
  - Lambda execution role requires `secretsmanager:GetSecretValue` permissions scoped to new ARNs.
- **Testing Guidance:**  
  - Use AWS CLI `aws secretsmanager get-secret-value` and validation script to confirm schema.  
  - Confirm denied access from unauthorized principals using IAM policy simulator.

### Testing

- Validation script: `scripts/validate_secrets.py` (implement in this story) should exit non-zero if any required key is missing, malformed, or inaccessible to the Lambda role.
- Manual checks: run `aws secretsmanager get-secret-value --secret-id naver-sms-automation/naver-credentials --profile <deployment-profile>` and verify JSON structure matches architecture doc guidance.
- IAM policy simulator: confirm principals outside the allowlist receive explicit denies when attempting `secretsmanager:GetSecretValue`.

---

## Definition of Done

- [ ] Functional requirements met  
- [ ] Integration requirements verified  
- [ ] Existing functionality regression tested (secrets retrieval smoke test)  
- [ ] Code follows existing patterns and standards  
- [ ] Tests pass (validation script)  
- [ ] Documentation updated

---

## Risk and Compatibility Check

- **Primary Risk:** Incorrect secret schema causing runtime failures in configuration loader.
- **Mitigation:** Validate schema against automated script and include unit tests in Epic 2 configuration loader story.
- **Rollback:** Delete new secrets and revert IaC stack to previous state; restore credentials temporarily via environment variables (short-lived) if necessary.

**Compatibility Verification**
- [x] No breaking changes to existing APIs (Secrets Manager integration additive)
- [x] Database unaffected
- [x] UI unaffected
- [x] Performance impact negligible (secrets cached in Lambda initialization)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Story drafted from Epic 1 requirements | Sarah (PO) |

---

## QA Results

*Pending review.*
