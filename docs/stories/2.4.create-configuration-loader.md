# Story 2.4: Create Configuration Loader

**Status:** Draft

---

## Story

**As a** developer,
**I want** a centralized configuration loader that aggregates environment variables, Secrets Manager values, and YAML configuration files,
**so that** the refactored modules can consume consistent settings without hardcoded constants.

---

## Acceptance Criteria

**Functional Requirements**
1. `src/config/settings.py` exposes a `Settings` dataclass (or pydantic model) with fields defined in the architecture doc (`docs/brownfield-architecture.md:1167-1198`) covering AWS region, DynamoDB tables, Naver credentials, SENS credentials, Telegram credentials, store definitions, option keywords, and rule definitions.
2. `Settings.load()` loads data in the following precedence: environment variables override Secrets Manager values, which override YAML defaults (`config/stores.yaml`, `config/sms_templates.yaml`, `config/rules.yaml`); missing required values raise a descriptive `ConfigurationError`.
3. Secrets are retrieved via boto3 Secrets Manager client using names defined in Story 1.2; loader parses JSON payloads into the appropriate fields and supports local development fallback via `.env.local` or `config/local-secrets.json`.
4. Loader caches results after first invocation within a Lambda cold start (thread-safe) and provides `reload()` hook for tests to force refresh.
5. Validation step ensures YAML structures conform to expected schema (e.g., rule entries have `name`, `conditions`, `actions`), failing fast with aggregated error messages; schema definitions stored in `config/schema/*.json` or inline dataclasses.

**Integration Requirements**
6. Downstream modules (auth, notifications, database, rules) consume `Settings` via dependency injection; story captures sample usage snippets in documentation.
7. Logging uses structured logger with sensitive fields redacted when settings are rendered (e.g., when debugging configuration values).
8. Unit tests cover: missing secret â†’ raises error, environment override precedence, YAML parsing, cache behavior, and reload functionality; integration test (with moto) verifies Secrets Manager interaction.

**Quality Requirements**
9. Documentation (`docs/config/README.md`) describes configuration sources, precedence rules, and how to add new settings.
10. Configuration loader is type-checked (mypy or pyright) with `strict` settings; CI pipeline updated to run type check and fail on regressions.
11. Validation evidence (unit test output, sample settings dump with redacted secrets) logged in `VALIDATION.md`.

---

## Tasks / Subtasks

- [ ] Implement settings dataclass/model (AC: 1, 2, 5)
- [ ] Integrate Secrets Manager and local fallback (AC: 3)
- [ ] Add caching, reload hooks, and logging (AC: 4, 7)
- [ ] Write unit/integration tests (AC: 8)
- [ ] Document configuration strategy (AC: 6, 9, 10, 11)

---

## Dev Notes

- **References:** Architecture configuration guidance (`docs/brownfield-architecture.md:1167-1198`), PRD security requirements (`docs/prd.md:224-270`), Stories 1.2/1.3 for secret schema.
- **Implementation Tips:** Use `functools.lru_cache` or module-level singleton for caching; define helper to redact string values in logs (`****1234` mask). Consider using pydantic `BaseSettings` for built-in validation if dependency accepted.
- **Testing Guidance:** Use moto to stub Secrets Manager responses; create fixture YAML files for stores/rules and ensure loader matches expected dataclasses.

---

## Definition of Done

- [ ] Functional loader available and verified  
- [ ] Tests and type checks pass  
- [ ] Documentation updated and shared  
- [ ] Validation artefacts captured

---

## Risk and Compatibility Check

- **Primary Risk:** Misconfigured loader causing runtime failures or exposing secrets.
- **Mitigation:** Strict validation, redaction in logs, thorough tests for precedence rules.
- **Rollback:** Revert to static configuration constants temporarily; keep legacy code path until loader proven stable.

**Compatibility Verification**
- [x] Works within Lambda cold-start constraints  
- [x] Supports local development without Secrets Manager access  
- [x] Aligns with upcoming rule engine configuration needs

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Story drafted from Epic 2 requirements | Sarah (PO) |

