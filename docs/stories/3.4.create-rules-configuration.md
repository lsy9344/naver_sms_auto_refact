# Story 3.4: Create `rules.yaml` Configuration

**Status:** Draft

---

## Quick Project Assessment

**Current System Context**
- [x] Legacy rule flows mapped in `original_code/lambda_function.py:120-210, 360-410`.
- [x] Supporting modules: condition evaluators (Story 3.2), action executors (Story 3.3), configuration loader (Story 2.4).
- [x] Integration points: `config/rules.yaml`, schema validation in rule engine core (Story 3.1).
- [x] Existing patterns: YAML-driven rule definitions with comments and metadata (`docs/brownfield-architecture.md:978-1015`).

**Change Scope**
- [x] Build complete `config/rules.yaml` capturing current production behavior plus future-ready toggles.
- [x] Provide schema definition and documentation for rule authors.
- [x] Success = declarative rules produce identical side effects compared to legacy logic (via regression tests).

---

## Story

**As a** product owner (authoring rules),
**I want** a declarative `rules.yaml` that encodes all current automation logic,
**so that** future rule changes require configuration edits rather than code deployments.

---

## Story Context

**Existing System Integration:**
- Integrates with: `Settings.load()` for configuration ingestion, `RuleEngine` constructor, condition/action registries.
- Technology: YAML configuration with templated parameters, Jinja-style placeholders allowed for notifications.
- Follows pattern: Example structures from architecture doc `docs/brownfield-architecture.md:978-1035`.
- Touch points: `config/rules.schema.json`, `docs/rules/rules-config.md`, regression comparison harness.

---

## Acceptance Criteria

**Functional Requirements**
1. `config/rules.yaml` defines all current rule flows: New Booking Confirmation, Two-Hour Reminder, Evening Option SMS, with `enabled: true`, descriptive `name`, `description`, and `tags`.
2. Each rule lists conditions and actions using the evaluator/executor identifiers established in Stories 3.2 and 3.3, with parameters matching legacy behavior (e.g., `time_before_booking` with `hours: 2`, `has_option_keyword` referencing option keyword list from config).
3. Additional scaffolding included for future rules (e.g., Slack notification template) but disabled via `enabled: false` and documentation, ensuring zero behavior change until activated.
4. YAML passes schema validation defined in `config/rules.schema.json`; schema includes enums for condition/action types, required parameter fields, and optional metadata (priority, notes).
5. Comments or `metadata:` blocks capture business context (store coverage, message templates) sourced from PRD to aid non-developer editors.

**Integration Requirements**
6. Configuration loader (Story 2.4) successfully loads rules into `Settings.rules`; sample program `scripts/print_rules.py` prints summary for verification.
7. Rule engine comparison harness processes legacy booking fixtures through new rules and confirms identical action sequences (SMS type, DB updates, notifications) recorded in `VALIDATION.md`.
8. Documentation (`docs/rules/rules-config.md`) explains file structure, editing guidelines, and testing workflow for rule authors; includes guidance on enabling/disabling rules and adding new ones safely.

**Quality Requirements**
9. Unit tests validate schema enforcement by attempting to load malformed rule definitions (missing fields, invalid types) and confirming descriptive errors.
10. YAML linting (e.g., `yamllint`, `spectral`) included in CI to guard formatting and schema conformance.
11. Versioning strategy documented: use semantic rule versions or Git tags; change log appended to file header with effective date and author.

---

## Technical Notes

- **Integration Approach:** YAML consumed by configuration loader, converted to `RuleConfig` dataclasses by rule engine core (Story 3.1).
- **Existing Pattern Reference:** Mapping table in Epic 3 and architecture doc lines 394-465 for condition/action equivalence.
- **Key Constraints:** No behavior changes allowed; ensure keyword lists, store IDs align with configuration files from Epic 2.

---

## Definition of Done

- [ ] Functional rules file created and validated
- [ ] Integration with loader and regression tests complete
- [ ] Documentation, schema, linting updated
- [ ] Evidence captured in `VALIDATION.md`

---

## Risk and Compatibility Check

- **Primary Risk:** Misconfigured YAML causing missed or duplicated SMS events.  
  **Mitigation:** Regression harness, schema validation, manual review by PO/QA before deployment.
- **Rollback:** Revert to previous `rules.yaml` version via Git; rule engine loads last known good configuration.

**Compatibility Verification**
- [x] Compatible with rule engine core and evaluators/executors  
- [x] Supports future extensions (Slack, date ranges) via disabled templates  
- [x] Aligns with PRD requirement for configuration-driven rules

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Story drafted from Epic 3 requirements | Sarah (PO) |

