# Story 6.4: Add Multi-Option Condition Evaluator

**Status:** ready for the development agent *(prerequisite for Story 6.1)*

---

## Quick Project Assessment

**Current System Context**
- [x] The rule engine currently exposes `has_option_keyword`, which only checks for any single keyword match and cannot enforce minimum counts or multiple keywords. [Source: src/rules/conditions.py:300-351]
- [x] Epic 6 requires a `has_multiple_options` evaluator that inspects booking option keywords and ensures a minimum number of matches, but no such function exists or is registered. [Source: docs/epics/epic-6-post-mvp-enhancements.md#new-condition-evaluators]
- [x] Rules schema lists `has_multiple_options` with parameters (`keywords`, `min_count`), so YAML rules can reference it but will fail at runtime due to missing evaluator. [Source: src/config/rules.schema.json:289-308]

**Change Scope**
- [x] Implement `has_multiple_options` evaluator supporting keyword lists and minimum match counts against booking option metadata. [Source: docs/epics/epic-6-post-mvp-enhancements.md#new-condition-evaluators]
- [x] Register the evaluator with the rule engine and update tests to cover edge cases (zero options, partial matches, counts). [Source: docs/testing/rule-engine-tests.md#test-organization]
- [x] Update documentation and fixtures so future rules (Story 6.1) can rely on the evaluator confidently. [Source: docs/epics/epic-6-post-mvp-enhancements.md#business-user-rule-management-guide]

---

## Story

**As a** rule configuration author,  
**I want** a `has_multiple_options` condition that enforces minimum keyword counts,  
**so that** holiday and promotion rules can target bookings where customers selected multiple specific options.

---

## Acceptance Criteria

1. `src/rules/conditions.py` defines `has_multiple_options(context, keywords, min_count)` that inspects `booking.option_keywords` (or equivalent flags) and returns `True` when at least `min_count` of the provided keywords match, handling string, list, dict option formats gracefully. [Source: docs/epics/epic-6-post-mvp-enhancements.md#new-condition-evaluators]
2. `register_conditions` registers `has_multiple_options`, and unit tests in `tests/rules/test_conditions.py` cover success, threshold, insufficient matches, missing data, and duplicate keyword scenarios. [Source: docs/testing/rule-engine-tests.md#test-organization]
3. Schema validation (`src/config/rules.schema.json`) matches the evaluator signature (keywords array + integer `min_count`), with error messages for invalid configs verified via unit tests. [Source: src/config/rules.schema.json]
4. Integration fixtures/tests (e.g., `tests/integration/test_rules_regression.py`) include bookings with varying option combinations to prove the evaluator integrates correctly without regressing existing behavior. [Source: docs/testing/rule-engine-tests.md#testing-strategy-for-this-epic]
5. Documentation (`docs/rules/rules-config.md` and `docs/testing/rule-engine-tests.md`) describes the evaluator, providing examples and guidance for business users on how to configure option keywords and counts. [Source: docs/epics/epic-6-post-mvp-enhancements.md#business-user-rule-management-guide]

---

## Tasks / Subtasks

- [ ] Task 1: Implement evaluator logic (AC: 1, 2)  
  - [ ] Add `has_multiple_options` to `src/rules/conditions.py`, reusing helper utilities (e.g., normalized keyword lists) and logging debug output for transparency. [Source: src/rules/conditions.py]  
  - [ ] Register the evaluator in `register_conditions` and update the log statement summarizing registered evaluators. [Source: src/rules/conditions.py]  
  - [ ] Extend unit tests in `tests/rules/test_conditions.py` to cover: sufficient matches, insufficient matches, higher `min_count`, empty keywords, missing `option_keywords`, and mixed-case handling. [Source: docs/testing/rule-engine-tests.md#test-organization]

- [ ] Task 2: Validate schema alignment (AC: 3)  
  - [ ] Ensure `src/config/rules.schema.json` parameter names/type constraints align with implementation (`keywords` array, `min_count` positive integer). [Source: src/config/rules.schema.json]  
  - [ ] Update schema-focused tests (if present) to assert descriptive validation errors when config omits keywords or sets `min_count` below 1. [Source: tests/unit/test_rules_schema.py]

- [ ] Task 3: Enhance integration coverage (AC: 4)  
  - [ ] Update fixtures in `tests/fixtures/` to include booking scenarios with multiple option keywords, ensuring regression expectations capture both passing and failing cases. [Source: docs/testing/rule-engine-tests.md#test-organization]  
  - [ ] Add integration assertions in `tests/integration/test_rules_regression.py` (or dedicated integration test) verifying `has_multiple_options` interacts correctly with other conditions/actions. [Source: docs/testing/rule-engine-tests.md]

- [ ] Task 4: Document evaluator usage (AC: 5)  
  - [ ] Update `docs/rules/rules-config.md` in the **Condition Types → Option-Based Conditions** section with a new `has_multiple_options` subsection, including YAML examples for `keywords` and `min_count`. [Source: docs/rules/rules-config.md]  
  - [ ] Refresh `docs/testing/rule-engine-tests.md` under **Test Suites → Unit Tests: Condition Evaluators** and **Integration Fixtures** to document the new multi-option scenarios and reference the specific fixture file added for this story once it is named. [Source: docs/testing/rule-engine-tests.md]

---

## Dev Notes

- **Data Sources:** Booking objects expose `option_keywords`, `has_pro_edit_option`, and related counts; ensure evaluator considers list values and fallback flags (`has_pro_edit_option`). [Source: src/domain/booking.py]  
- **Normalization:** Treat keywords case-sensitively per existing patterns unless business requirements dictate otherwise; document behavior. [Source: docs/epics/epic-6-post-mvp-enhancements.md#new-condition-evaluators]  
- **Performance:** Evaluator operates on small lists; simple loops suffice. Avoid mutating booking context. [Source: docs/brownfield-architecture.md#rule-evaluation]

### Testing

- `pytest tests/rules/test_conditions.py -k "multiple_options" -v` (unit coverage).  
- `pytest tests/integration/test_rules_regression.py -k "multiple_options" -v` (integration/regression).  
- `pytest tests -m integration --cov=src/rules --cov-report=term-missing` (maintain coverage target).

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 0.1 | Initial draft defining multi-option evaluator work | Sarah (Product Owner) |

---

## Definition of Done

- [ ] Evaluator implemented and registered  
- [ ] Tests (unit/integration) updated and passing  
- [ ] Schema alignment verified  
- [ ] Documentation updated  
- [ ] Rollback plan (remove evaluator + config references) documented

---

## Risk & Compatibility

- **Primary Risk:** Miscounting option keywords could trigger false positives/negatives in critical campaigns.  
- **Mitigation:** Unit tests for thresholds, integration fixtures for real scenarios, and logging for troubleshooting.  
- **Rollback:** Remove evaluator and config references; Story 6.1 should not proceed until reinstated.

**Compatibility Verification**
- [x] No breaking API changes; evaluator adds capability only  
- [x] Database untouched  
- [x] UI unaffected  
- [x] Performance impact negligible (small iterations)

---

## Validation Checklist

**Scope Validation**
- [x] Work confined to evaluator + tests/docs  
- [x] Integration leverages existing registry pattern  
- [x] No new architecture decisions required  
- [x] Rollback straightforward (remove function/registration)

**Clarity Check**
- [x] Requirements specify files/tests  
- [x] Integration points explicit  
- [x] Success criteria testable  
- [x] Rollback path documented
