# Story 5.1: Deploy to ECR

**Status:** Draft

---

## Quick Project Assessment

**Current System Context**
- [x] Deployment phase requires containerizing the Lambda and pushing to Amazon ECR before any parallel run begins (`docs/epics/epic-5-deployment.md:19-107`).
- [x] Architecture blueprint defines the post-migration workflow for building the Docker image, tagging, and pushing it to account `654654307503` in region `ap-northeast-2` (`docs/brownfield-architecture.md:1348-1393`, `docs/epics/epic-5-deployment.md:95-109`).
- [x] CI pipeline snippet already documents the AWS Actions sequence for logging into ECR and publishing tagged images to the `naver-sms-automation` repository (`docs/brownfield-architecture.md:1570-1599`).
- [x] Security gate requires container image scans to report zero critical vulnerabilities before go-live (`docs/epics/epic-5-deployment.md:206-209`).

**Change Scope**
- [x] Build the production container image from the existing Dockerfile and dependencies so the new Lambda runtime matches what Stories 2.x-4.x delivered (`docs/brownfield-architecture.md:1381-1405`).
- [x] Push the image to the shared ECR repository with immutable (`v1.0.0`) and rolling (`latest`) tags, keeping size under 10 GB (`docs/epics/epic-5-deployment.md:206-209`).
- [x] Leave the existing AWS Lambda (zip + layers) deployment untouched; only publish the new image artifact needed for the parallel deployment plan (`docs/epics/epic-5-deployment.md:83-174`).
- [x] Capture image digest, vulnerability scan results, and publishing steps so downstream cutover and rollback decisions have traceable evidence (`docs/epics/epic-5-deployment.md:260-273`).

---

## Story

**As a** platform engineer,  
**I want** to publish the production-ready Lambda container image to our ECR registry with validated security scans,  
**so that** the deployment team can launch the parallel Lambda without risking runtime drift or unvetted artifacts.

---

## Story Context

- Epic 5 begins with a go/no-go gate that hinges on the new container image existing in Amazon ECR before any parallel execution starts (`docs/epics/epic-5-deployment.md:260-266`).
- The architecture migration plan already specifies the Dockerfile layout, Chrome/Chromedriver installation, and tagging conventions that must be preserved in the container build (`docs/brownfield-architecture.md:1348-1405`).
- GitHub Actions pipeline steps for ECR login, build, push, and retagging to `latest` are available and should be reused or adapted for manual execution if CI is not yet wired (`docs/brownfield-architecture.md:1570-1593`).
- Security expectations include enabling ECR vulnerability scans and blocking promotion if any critical findings appear, aligning with the epic’s risk controls (`docs/epics/epic-5-deployment.md:206-209`).

---

## Acceptance Criteria

**Functional Requirements**
1. Container image is built from the repository Dockerfile with all runtime dependencies (Chrome, Chromedriver, Python requirements) matching the migration plan (`docs/brownfield-architecture.md:1381-1405`).
2. Image is pushed to `654654307503.dkr.ecr.ap-northeast-2.amazonaws.com/naver-sms-automation` with both `v1.0.0` and `latest` tags recorded, and a successful push is confirmed via `aws ecr describe-images` output (`docs/epics/epic-5-deployment.md:95-104`, `docs/epics/epic-5-deployment.md:206-209`).
3. Published image metadata (digest, size, tags) is documented in the deployment notes for use by Stories 5.2–5.6 (`docs/epics/epic-5-deployment.md:206-274`).

**Integration Requirements**
4. Existing zip-based Lambda deployment pipeline is left untouched so current production traffic continues without interruption during this story (`docs/epics/epic-5-deployment.md:83-168`).
5. IAM permissions for the ECR repository continue to allow pushes only from the CI/deployment role and pulls only from the Lambda execution role; any adjustments are reviewed with the infra team before merge (`docs/qa/infra-security-review-1.5.md:18-31`).
6. Resulting ECR image remains under 10 GB to comply with Lambda container limits and avoids introducing new base images or runtime divergences that could break later cutover tasks (`docs/epics/epic-5-deployment.md:206-209`).

**Quality Requirements**
7. AWS ECR vulnerability scanning runs on both `v1.0.0` and `latest` tags and reports zero critical findings before sign-off (`docs/epics/epic-5-deployment.md:206-209`).
8. Build and push steps (including commands, AWS profile/role used, and scan evidence) are logged in `VALIDATION.md` or a linked deployment note so QA can verify artifacts during the go/no-go review (`docs/epics/epic-5-deployment.md:260-273`).
9. If any vulnerability is detected, mitigation steps (package upgrade, base image patch, or exception rationale) are captured and re-scanned until the findings meet deployment policy (`docs/epics/epic-5-deployment.md:206-209`).

---

## Tasks / Subtasks

- [ ] Build container image locally or via CI using the defined Dockerfile and ensure Chrome/Chromedriver paths match architecture expectations (AC 1, AC 6)
  - [ ] Verify resulting image ID and size with `docker images` before tagging (AC 6)
- [ ] Authenticate to Amazon ECR (`aws ecr get-login-password` or GitHub Action) and push the image with `v1.0.0` and `latest` tags (AC 2)
  - [ ] Run `aws ecr describe-images --repository-name naver-sms-automation` to confirm tags and digest (AC 2, AC 3)
- [ ] Trigger or retrieve ECR vulnerability scans for both tags and archive the reports with the deployment notes (AC 7, AC 8, AC 9)
- [ ] Document build/push steps, image metadata, and scan results in project docs for downstream stories (AC 3, AC 8)

---

## Dev Notes

- **AWS Account & Region:** Use account `654654307503` in `ap-northeast-2`; repository name is `naver-sms-automation` (`docs/epics/epic-5-deployment.md:95-103`).
- **Dockerfile Expectations:** Follow the Chrome/Chromedriver installation and dependency layering called out in the architecture doc so runtime parity holds during Lambda execution (`docs/brownfield-architecture.md:1348-1405`).
- **Build & Push Commands:** Baseline manual sequence is:
  ```bash
  docker build -t naver-sms-automation .
  docker tag naver-sms-automation:latest 654654307503.dkr.ecr.ap-northeast-2.amazonaws.com/naver-sms-automation:v1.0.0
  docker tag naver-sms-automation:latest 654654307503.dkr.ecr.ap-northeast-2.amazonaws.com/naver-sms-automation:latest
  aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 654654307503.dkr.ecr.ap-northeast-2.amazonaws.com
  docker push 654654307503.dkr.ecr.ap-northeast-2.amazonaws.com/naver-sms-automation:v1.0.0
  docker push 654654307503.dkr.ecr.ap-northeast-2.amazonaws.com/naver-sms-automation:latest
  ```
  (`docs/epics/epic-5-deployment.md:95-104`, `docs/brownfield-architecture.md:1363-1392`)
- **CI Reuse:** GitHub Actions workflow steps under “Build, tag, and push image to Amazon ECR” can be parameterized with the `v1.0.0` release tag or SHA to automate pushes in future runs (`docs/brownfield-architecture.md:1570-1593`).
- **Security Scan:** Use `aws ecr start-image-scan` and `aws ecr describe-image-scan-findings` for both tags; attach JSON or summarized results alongside the story artifacts before marking complete (`docs/epics/epic-5-deployment.md:206-209`).
- **Evidence Sharing:** Record the pushed image digest (e.g., `sha256:...`), size, and scan outcome in `VALIDATION.md` so Stories 5.2–5.6 can reference the exact artifact during deployment and rollback decisions (`docs/epics/epic-5-deployment.md:206-274`).

### Testing

- Run `make docker-build` or `docker build` locally to ensure the image builds without error; capture build logs for traceability (`docs/brownfield-architecture.md:1363-1393`).
- After pushing, execute `aws ecr describe-images --repository-name naver-sms-automation --image-ids imageTag=latest` and store the JSON output as evidence (`docs/epics/epic-5-deployment.md:206-209`).
- Initiate ECR vulnerability scans (`aws ecr start-image-scan`) and confirm `findingSeverityCounts` excludes `CRITICAL`; rerun after any remediation (`docs/epics/epic-5-deployment.md:206-209`).

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 0.1 | Initial draft created from Epic 5 deployment requirements | Sarah (PO) |
