# Story 2.2: Extract SENS SMS Module

**Status:** Draft

---

## Story

**As a** developer,
**I want** to extract the SENS SMS sending logic into a dedicated notifications module,
**so that** SMS delivery remains identical while templates and store metadata move into configuration files.

---

## Acceptance Criteria

**Functional Requirements**
1. `SensSmsClient` (or equivalent) lives in `src/notifications/sms_service.py` and preserves the exact signature generation algorithm and request headers from `original_code/sens_sms.py:63-109` without modification (byte-for-byte comparison of generated signature for a fixed timestamp passes).
2. SMS templates (`booking_confirm_template`, all store-specific guide templates, `event_template`) are externalized to `config/sms_templates.yaml` with content identical to the legacy strings (character-for-character including whitespace and line breaks); unit test verifies parity against serialized legacy fixtures.
3. Store-to-phone mapping migrates to `config/stores.yaml`, preserving all existing store IDs, names, and default “from” numbers (including special case for store `867589`); client loads mapping at runtime and falls back to default number when mapping missing.
4. Public API exposes `send_confirm_sms(phone)`, `send_guide_sms(store_id, phone)`, and `send_event_sms(phone)` with the same behavior and return semantics as the original `Sens_sms` class.
5. Message payload structure (JSON body, field names, timestamp format) sent to the SENS REST endpoint remains unchanged; integration smoke test captures request body and headers and matches legacy fixture.

**Integration Requirements**
6. Client retrieves credentials (access key, secret key, service ID, default from number) from the configuration loader/Secrets Manager (Story 1.3) instead of hardcoded literals; local override via environment variables documented for testing.
7. Module emits structured logs (INFO for send start/end, WARNING for retries, ERROR for failures) using the logging helper introduced in Story 2.5, without logging PII (phone numbers must be masked except last four digits).
8. Unit tests cover template loading, signature generation, phone masking, and error handling (network failures raise custom exception); integration tests (with moto or stubbed HTTP) validate request payloads.

**Quality Requirements**
9. Static analysis (bandit/detect-secrets) confirms no secrets remain in the module; evidence recorded in `VALIDATION.md`.
10. Documentation added to `docs/notifications/sms-service.md` explaining template structure, configuration files, and how to add new stores/templates safely.
11. Legacy module `original_code/sens_sms.py` referenced in validation checklist for regression comparison and marked deprecated once parity confirmed.

---

## Tasks / Subtasks

- [ ] Create `src/notifications/sms_service.py` (AC: 1, 4, 5)
  - [ ] Port class structure and public methods
  - [ ] Preserve signature/header logic exactly
- [ ] Externalize templates and store config (AC: 2, 3, 6)
  - [ ] Create YAML files and loader helpers
  - [ ] Inject `Settings` (Story 2.4) so credentials and paths come from centralized loader
  - [ ] Add integrity tests comparing legacy content
- [ ] Implement logging and masking (AC: 7)
  - [ ] Use structured logger with masked phone helper (Story 2.5 interface)
- [ ] Add tests and validation artefacts (AC: 8, 9)
  - [ ] Unit/integration tests (capture fixture payloads under `tests/fixtures/sens/`)
  - [ ] Update `VALIDATION.md` with static-analysis evidence, parity diffs, and smoke-test details
- [ ] Document usage (AC: 10, 11)
  - [ ] Write module README with env override workflow and dependency map
  - [ ] Update story checklist referencing legacy module deprecation

---

## Dev Notes

- **Architecture References:** See `docs/brownfield-architecture.md:508-602` for SENS signature/header preservation requirements and template content that must remain byte-identical. The module layout target is outlined in `docs/brownfield-architecture.md:927-1000`.
- **Epic / PRD Traceability:** Epic preservation checklist (`docs/epics/epic-2-code-extraction.md`) and PRD monitoring requirements (`docs/prd.md:134-159`) define regression expectations and logging/monitoring hooks.
- **Legacy Source:** `original_code/sens_sms.py` is the canonical baseline for signature logic, payload structure, and template strings; tests must compare against these fixtures to satisfy AC1–5.
- **Configuration Loader:** Consume SENS credentials, template paths, and store metadata via `src/config/settings.py::Settings` (Story 2.4). Inject a `Settings` instance or loader function into the SMS service instead of reading YAML/Secrets directly inside the module.
- **Logging Integration:** Leverage `src/utils/logger.py::get_logger` (Story 2.5) for structured logging. Until Story 2.5 lands, maintain compatibility by coding against the documented interface (INFO start/end, WARNING retry, ERROR failure) and masking phone numbers at the logging boundary.

### Testing

**Unit Test Suite:** `tests/unit/test_sms_service.py` (new) should cover template loader integrity, signature generation parity with `original_code/sens_sms.py`, phone masking helper, retry/error handling logic, and `Settings` dependency injection boundaries using fakes for HTTP transport.  
**Integration Test Suite:** `tests/integration/test_sms_service_payloads.py` should replay fixture payloads against a stubbed SENS endpoint (mocked `requests` session) and assert headers/body equality with legacy captures stored under `tests/fixtures/sens/`. Capture at least one canonical request (confirm, guide, event) and persist fixture JSON/headers for regression comparison (AC5).  
**Validation Evidence:** Record Bandit/detect-secrets output hashes, signature parity diff summaries, and integration smoke-test fixture locations in `VALIDATION.md` under a new “Story 2.2” heading.  
**Environment Overrides:** Document required env vars (`SENS_ACCESS_KEY`, `SENS_SECRET_KEY`, `SENS_SERVICE_ID`, `SENS_DEFAULT_FROM`) plus local YAML override path in `docs/notifications/sms-service.md` so developers can exercise AC6 manually. Include examples of invoking the module with overrides for unit/integration tests.

### Testing Standards

- **Test Locations:** Place unit tests in `tests/unit/test_sms_service.py`; integration smoke tests in `tests/integration/test_sms_service_payloads.py`.
- **Frameworks / Tools:** Use `pytest` with request-stubbing fixtures (patch `requests.Session` or equivalent) and deterministic timestamp helpers (e.g., monkeypatching `datetime.utcnow`); follow existing repo fixtures pattern under `tests/fixtures/`.
- **Coverage Expectations:** Maintain ≥80% branch coverage for the notifications module; ensure signature and template parity assertions run in CI.
- **Static Analysis:** Execute `bandit -r src/notifications` and `detect-secrets scan` as evidence for AC9; attach command outputs to `VALIDATION.md`.

---

## Definition of Done

- [ ] Functional requirements met  
- [ ] Integration hooks wired to new config loader  
- [ ] Tests and static analysis pass  
- [ ] Documentation and validation artefacts updated

---

## Risk and Compatibility Check

- **Primary Risk:** Altered signature or template content causing SMS failures.
- **Mitigation:** Character-by-character content comparison, signed request regression tests, and live staging send prior to production deploy.
- **Rollback:** Swap back to legacy `sens_sms.py` module within container image; retain original file for emergency redeploy.

**Compatibility Verification**
- [x] External API contracts unchanged  
- [x] Works with rule engine roadmap (actions module consumes same interface)  
- [x] Performance impact minimal (templates loaded once per cold start)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Story drafted from Epic 2 requirements | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
_Reserved for Dev Agent_

### Debug Log References
_Reserved for Dev Agent_

### Completion Notes List
_Reserved for Dev Agent_

### File List
_Reserved for Dev Agent_

---

## QA Results

_Reserved for QA Agent_
