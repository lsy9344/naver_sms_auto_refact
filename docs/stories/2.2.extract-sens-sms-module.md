# Story 2.2: Extract SENS SMS Module

**Status:** Draft

---

## Story

**As a** developer,
**I want** to extract the SENS SMS sending logic into a dedicated notifications module,
**so that** SMS delivery remains identical while templates and store metadata move into configuration files.

---

## Acceptance Criteria

**Functional Requirements**
1. `SensSmsClient` (or equivalent) lives in `src/notifications/sms_service.py` and preserves the exact signature generation algorithm and request headers from `original_code/sens_sms.py:63-109` without modification (byte-for-byte comparison of generated signature for a fixed timestamp passes).
2. SMS templates (`booking_confirm_template`, all store-specific guide templates, `event_template`) are externalized to `config/sms_templates.yaml` with content identical to the legacy strings (character-for-character including whitespace and line breaks); unit test verifies parity against serialized legacy fixtures.
3. Store-to-phone mapping migrates to `config/stores.yaml`, preserving all existing store IDs, names, and default “from” numbers (including special case for store `867589`); client loads mapping at runtime and falls back to default number when mapping missing.
4. Public API exposes `send_confirm_sms(phone)`, `send_guide_sms(store_id, phone)`, and `send_event_sms(phone)` with the same behavior and return semantics as the original `Sens_sms` class.
5. Message payload structure (JSON body, field names, timestamp format) sent to the SENS REST endpoint remains unchanged; integration smoke test captures request body and headers and matches legacy fixture.

**Integration Requirements**
6. Client retrieves credentials (access key, secret key, service ID, default from number) from the configuration loader/Secrets Manager (Story 1.3) instead of hardcoded literals; local override via environment variables documented for testing.
7. Module emits structured logs (INFO for send start/end, WARNING for retries, ERROR for failures) using the logging helper introduced in Story 2.5, without logging PII (phone numbers must be masked except last four digits).
8. Unit tests cover template loading, signature generation, phone masking, and error handling (network failures raise custom exception); integration tests (with moto or stubbed HTTP) validate request payloads.

**Quality Requirements**
9. Static analysis (bandit/detect-secrets) confirms no secrets remain in the module; evidence recorded in `VALIDATION.md`.
10. Documentation added to `docs/notifications/sms-service.md` explaining template structure, configuration files, and how to add new stores/templates safely.
11. Legacy module `original_code/sens_sms.py` referenced in validation checklist for regression comparison and marked deprecated once parity confirmed.

---

## Tasks / Subtasks

- [ ] Create `src/notifications/sms_service.py` (AC: 1, 4, 5)
  - [ ] Port class structure and public methods
  - [ ] Preserve signature/header logic exactly
- [ ] Externalize templates and store config (AC: 2, 3, 6)
  - [ ] Create YAML files and loader helpers
  - [ ] Add integrity tests comparing legacy content
- [ ] Implement logging and masking (AC: 7)
  - [ ] Use structured logger with masked phone helper
- [ ] Add tests and validation artefacts (AC: 8, 9)
  - [ ] Unit/integration tests
  - [ ] Update `VALIDATION.md` with results
- [ ] Document usage (AC: 10, 11)
  - [ ] Write module README and update story checklist

---

## Dev Notes

- **References:** Architecture preservation guidance (`docs/brownfield-architecture.md:500-610`), PRD monitoring requirements (`docs/prd.md:134-159`), legacy implementation `original_code/sens_sms.py`.
- **Implementation Tips:** Load YAML using `safe_load`, cache templates for performance, allow future template versioning via hash comparisons.
- **Testing Guidance:** Capture real SENS request using staging credentials to verify headers/timestamps; use `responses` or `httpretty` for deterministic tests.

---

## Definition of Done

- [ ] Functional requirements met  
- [ ] Integration hooks wired to new config loader  
- [ ] Tests and static analysis pass  
- [ ] Documentation and validation artefacts updated

---

## Risk and Compatibility Check

- **Primary Risk:** Altered signature or template content causing SMS failures.
- **Mitigation:** Character-by-character content comparison, signed request regression tests, and live staging send prior to production deploy.
- **Rollback:** Swap back to legacy `sens_sms.py` module within container image; retain original file for emergency redeploy.

**Compatibility Verification**
- [x] External API contracts unchanged  
- [x] Works with rule engine roadmap (actions module consumes same interface)  
- [x] Performance impact minimal (templates loaded once per cold start)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Story drafted from Epic 2 requirements | Sarah (PO) |

