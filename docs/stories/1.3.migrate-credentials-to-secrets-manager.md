# Story 1.3: Migrate Credentials to Secrets Manager

**Status:** Draft

---

## Story

**As a** security-focused developer,  
**I want** to remove all hardcoded credentials from the codebase and store them in AWS Secrets Manager,  
**so that** the refactored system complies with security requirements and prevents credential leakage.

---

## Acceptance Criteria

**Functional Requirements**
1. All credentials called out in the PRD and architecture review (Naver login, SENS API keys, Telegram bot token/chat ID) are deleted from source files (`original_code/lambda_function.py`, `original_code/sens_sms.py`, commit history reviewed) and replaced with configuration loader lookups wired to Secrets Manager.
2. Application configuration modules (`src/config/settings.py` and any interim bootstrap code) successfully fetch the new secrets using `boto3.client('secretsmanager')` with names established in Story 1.2, and raise a descriptive error if missing.
3. Environment bootstrap scripts (`scripts/bootstrap_env.sh` or similar) document the minimal IAM permissions required (`secretsmanager:GetSecretValue`, `kms:Decrypt` if default key) and confirm credentials are never echoed or logged.

**Integration Requirements**
4. Lambda container entrypoint (`src/main.py` placeholder) reads secrets during cold start and caches them; no secret values are written to CloudWatch Logs (verified via structured logging redaction helper).
5. Local development guide (`README.md` or `docs/dev/local-setup.md`) explains how engineers fetch temporary credentials via AWS CLI profiles without copying values into source files.
6. Existing unit/integration tests that relied on hardcoded credentials are updated to use dependency injection or fixtures (e.g., `tests/integration/test_naver_auth_live.py`) so test suites run with mock secrets or skip when secrets unavailable.

**Quality Requirements**
7. Static analysis/security scanning (`bandit`, `detect-secrets`, or project-equivalent) runs clean with no hardcoded credential findings; evidence attached to `VALIDATION.md`.
8. Code review checklist in `docs/brownfield-architecture.md` or `docs/QA` updated to include “Secrets retrieved from Secrets Manager” gate.
9. Git history scrub completed for sensitive values (BFG or `git filter-repo`) with documented steps and confirmation that public history no longer contains the credentials, or risk accepted and tracked if not feasible.

---

## Tasks / Subtasks

- [ ] Remove hardcoded credentials (AC: 1)
  - [ ] Delete literals from legacy modules
  - [ ] Replace with configuration loader calls
- [ ] Wire configuration loader to Secrets Manager (AC: 2, 4)
  - [ ] Update `src/config/settings.py`
  - [ ] Add caching/error handling
- [ ] Update developer documentation (AC: 3, 5)
  - [ ] Document IAM permissions and retrieval process
  - [ ] Update local setup guides
- [ ] Update tests and tooling (AC: 6, 7)
  - [ ] Inject secrets via fixtures/mocks
  - [ ] Run security scans and capture evidence
- [ ] Clean up history / tracking (AC: 8, 9)
  - [ ] Update QA checklist
  - [ ] Document history scrub or accepted risk

---

## Dev Notes

- **References:**  
  - Hardcoded credential analysis in `docs/brownfield-architecture.md:686-710, 1860-1870`.  
  - PRD security requirements (`docs/prd.md:134-160, 224-270`).  
  - Story 1.2 secret names and schemas (`docs/stories/1.2.setup-secrets-manager.md`).
- **Implementation Guidance:**  
  - Use boto3 Secrets Manager client with exponential backoff for retrieval.  
  - Leverage `functools.lru_cache` or module-level caching to avoid repeated calls.  
  - Ensure secrets are decrypted using default AWS-managed KMS key unless custom key defined later.
- **Testing Tips:**  
  - Introduce environment variable override (`USE_LOCAL_SECRETS_FILE`) for offline development with dummy JSON.  
  - Add unit tests verifying redaction helper strips secret substrings from logs.

---

## Definition of Done

- [ ] Functional requirements met  
- [ ] Integration requirements verified  
- [ ] Security scans and tests pass  
- [ ] Documentation updated  
- [ ] Evidence logged in `VALIDATION.md`

---

## Risk and Compatibility Check

- **Primary Risk:** Missing secret retrieval causing runtime failure.  
  **Mitigation:** Fallback validation script before deployment; CloudWatch alarm for secret access errors.

- **Rollback Plan:** Reintroduce temporary environment variables for secrets (short-term) and redeploy previous container image while investigating.

**Compatibility Verification**
- [x] No API changes visible to consumers  
- [x] Database unchanged  
- [x] UI unaffected  
- [x] Performance impact minimal (single cold-start fetch)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Story drafted from Epic 1 requirements | Sarah (PO) |

