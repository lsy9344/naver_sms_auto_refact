# Story 4.1: Create main.py Lambda Handler

**Status:** Draft

---

## Story

**As an** integration-focused developer,\
**I want** to build the new `src/main.py` Lambda entrypoint that orchestrates authentication, booking retrieval, rule processing, and notifications,\
**so that** the refactored system replicates the legacy automation flow inside the containerized runtime.

This story unlocks end-to-end execution for all Phase 4 workstreams and carries high regression risk.

---

## Acceptance Criteria

1. `lambda_handler` applies logging redaction and loads Naver, SENS, Telegram, and rules configuration through `Settings` before any external calls, matching the configuration loader design. [Source: architecture/brownfield-architecture.md#Configuration Loader (`src/config/settings.py`)]
2. Handler instantiates a DynamoDB-backed `SessionManager`, reuses cached cookies when valid, saves refreshed cookies on change, and delegates authentication to `NaverAuthenticator` exactly as the preserved login flow specifies. [Source: architecture/brownfield-architecture.md#Preserving Naver Login Flow]
3. Using the authenticated `requests.Session`, the handler retrieves confirmed (`RC03`) and completed (`RC08`) bookings for each configured store, applying phone formatting and KST timestamp normalization as defined for the Naver Booking API. [Source: architecture/brownfield-architecture.md#Naver Booking API Details]
4. Each booking is converted into the domain model, paired with its DynamoDB SMS record, and wrapped in a rule engine context containing booking data, DB record, current time, and settings prior to evaluation. [Source: architecture/brownfield-architecture.md#Data Models and Persistence] [Source: architecture/brownfield-architecture.md#Rule Engine Integration]
5. Rule processing initializes the existing `RuleEngine`, registers all condition and action executors, and processes every booking, yielding the structured `ActionResult` collection demanded by the architecture. [Source: architecture/brownfield-architecture.md#Rule Engine Integration]
6. The handler persists DynamoDB mutations (create/update SMS flags) via the database client and emits Telegram summary notifications that mirror the integration-contract table. [Source: architecture/brownfield-architecture.md#Integration Points and External Dependencies]
7. Successful invocations return `{'statusCode': 200, 'body': json.dumps({...})}` summarizing bookings processed and action results, while any exception logs the failure, sends a Telegram alert, and returns `{'statusCode': 500, ...}`. [Source: architecture/brownfield-architecture.md#Integration Considerations for Refactoring]
8. Runtime logging respects the secret-redaction mandate so no credentials or tokens (highlighted as critical technical debt) appear in CloudWatch. [Source: architecture/brownfield-architecture.md#Critical Technical Debt]
9. Automated tests include at least one `tests/e2e/test_lambda_handler.py` smoke that exercises the orchestration with mocks/stubs and maintains >80% coverage for new handler code, consistent with the recommended test strategy. [Source: architecture/brownfield-architecture.md#Recommended Test Strategy]
10. Slack notification wiring follows the planned action executor blueprint so summary payloads can be routed to Slack when the executor is enabled. [Source: architecture/brownfield-architecture.md#Rule Engine Integration] [Source: architecture/brownfield-architecture.md#Integration Points and External Dependencies]

---

## Tasks / Subtasks

- [ ] Bootstrap the handler lifecycle (AC: 1, 2)  
  - [ ] Invoke `Settings` loader once per cold start and attach logging redaction before any secrets are fetched. [Source: architecture/brownfield-architecture.md#Configuration Loader (`src/config/settings.py`)]  
  - [ ] Initialize DynamoDB resources and `SessionManager`, leveraging cached cookies when present and persisting refreshed cookies after re-authentication. [Source: architecture/brownfield-architecture.md#Preserving Naver Login Flow]

- [ ] Implement booking retrieval orchestration (AC: 3)  
  - [ ] Instantiate the Naver booking API client with the authenticated session and fetch both confirmed (`RC03`) and completed (`RC08`) bookings for every store listed in settings. [Source: architecture/brownfield-architecture.md#Naver Booking API Details]  
  - [ ] Normalize booking data (phone formatting, timezone conversion, option keyword detection) before handing to downstream processing. [Source: architecture/brownfield-architecture.md#Naver Booking API Details]

- [ ] Build rule-engine-ready contexts (AC: 4)  
  - [ ] Map bookings into domain models and retrieve existing SMS records from DynamoDB to populate context fields. [Source: architecture/brownfield-architecture.md#Data Models and Persistence]  
  - [ ] Ensure context includes booking, db_record, current time, settings, and database client per rule engine expectations. [Source: architecture/brownfield-architecture.md#Rule Engine Integration]

- [ ] Execute rule engine and persist results (AC: 5, 6)  
  - [ ] Initialize `RuleEngine`, register all condition evaluators and action executors, and process each booking to collect `ActionResult` objects. [Source: architecture/brownfield-architecture.md#Rule Engine Integration]  
  - [ ] Apply resulting actions to DynamoDB and send summary Telegram notifications of processed bookings/actions. [Source: architecture/brownfield-architecture.md#Integration Points and External Dependencies]
  - [ ] Ensure Slack notification executor configuration is documented and ready for activation alongside Telegram. [Source: architecture/brownfield-architecture.md#Action Executors (`src/rules/actions.py`)]

- [ ] Finalize response, error handling, and logging (AC: 7, 8)  
  - [ ] Construct success response payload capturing processed counts and rule outcomes; on exceptions, log with redaction, trigger Telegram alert, and return 500 response. [Source: architecture/brownfield-architecture.md#Integration Considerations for Refactoring] [Source: architecture/brownfield-architecture.md#Critical Technical Debt]

- [ ] Deliver automated coverage (AC: 9)  
  - [ ] Add `tests/e2e/test_lambda_handler.py` smoke test (mocks external services) validating happy-path orchestration and failure handling. [Source: architecture/brownfield-architecture.md#Recommended Test Strategy]  
  - [ ] Update coverage configuration to keep handler logic above 80% line coverage alongside existing regression suites. [Source: architecture/brownfield-architecture.md#Testing Reality]

---

## Dev Notes

### Previous Story Insights

- Rule engine tests now compare action type, params, and success flags; handler summaries must stay compatible with this richer `ActionResult` structure. [Source: stories/3.5.unit-tests-for-rule-engine.md#Completion Notes List]
- Repository-wide `pytest tests` currently fails due to a pre-existing `ConfigurationError` import issue, so expect to scope validations to the new smoke suite until that defect is resolved separately. [Source: stories/3.5.unit-tests-for-rule-engine.md#Debug Log References]

### Data Models

- Booking payloads combine `biz_id`, `bookingId`, phone number normalization, option keyword flags, and reservation timestamps (converted to KST). [Source: architecture/brownfield-architecture.md#Naver Booking API Details]
- DynamoDB `sms` table uses composite key `{booking_num, phone}` plus confirm/remind/option flags; `session` table stores cached cookies under key `'1'`. [Source: architecture/brownfield-architecture.md#Data Models and Persistence]

### API Specifications

- Naver Booking API endpoints require owner role headers, support pagination, and separate confirmed (`RC03`) vs completed (`RC08`) datasets that must both feed the rule engine each run. [Source: architecture/brownfield-architecture.md#Naver Booking API Details]

### Component Specifications

- Authentication flow must call Selenium-based `NaverAuthenticator` and reuse cookies via `SessionManager` before deriving a `requests.Session` for REST traffic. [Source: architecture/brownfield-architecture.md#Preserving Naver Login Flow]
- Rule evaluation requires registered conditions/actions with the YAML-driven `RuleEngine` pipeline from Epic 3. [Source: architecture/brownfield-architecture.md#Rule Engine Integration]
- Telegram notifications remain the mechanism for summary reporting and error alerts in integration builds. [Source: architecture/brownfield-architecture.md#Integration Points and External Dependencies]
- Slack action executor is slated for activation post-integration; document configuration inputs (webhook, channel) so handler summaries can be dual-routed when enabled. [Source: architecture/brownfield-architecture.md#Action Executors (`src/rules/actions.py`)]

### Slack Notification Configuration

- Slack notifications reuse the rule engine action executor pattern (`send_slack`) and require configuration for webhook URL, target channel, and message template to mirror Telegram summaries. [Source: architecture/brownfield-architecture.md#Action Executors (`src/rules/actions.py`)]
- Store secrets in AWS Secrets Manager alongside Telegram credentials and surface them through the settings loader, ensuring redaction filters cover Slack tokens. [Source: architecture/brownfield-architecture.md#Critical Technical Debt]
- Handler design should allow toggling Slack summaries without code changes by enabling a Slack rule/action in `config/rules.yaml`, keeping transport concerns encapsulated in the notifications module. [Source: architecture/brownfield-architecture.md#Notification abstraction (SMS, Slack, etc.)]

### File Locations

- Target entrypoint resides at `src/main.py`, aligning with the proposed refactored source tree that moves logic out of `oroginal_code/lambda_function.py`. [Source: architecture/brownfield-architecture.md#Project Structure (Actual)]

### Testing Requirements

- Phase 4 mandates integration and comparison tests, with handler smoke tests categorized under `tests/e2e/test_lambda_handler.py` plus supporting fixtures. [Source: architecture/brownfield-architecture.md#Recommended Test Strategy]
- Maintain >80% coverage across modules and ensure regression harness compatibility introduced in Story 3.5. [Source: stories/3.5.unit-tests-for-rule-engine.md#Testing]

### Technical Constraints

- Secrets must come from Secrets Manager (no hardcoded credentials) and logging must redact secret values to avoid repeating the highlighted technical debt. [Source: architecture/brownfield-architecture.md#Critical Technical Debt]
- Chrome/ChromeDriver must operate with `/tmp`-scoped directories inside the Lambda container; handler should leave the Selenium lifecycle managed within `NaverAuthenticator`. [Source: architecture/brownfield-architecture.md#Integration Considerations for Refactoring]
- EventBridge continues to trigger every 20 minutes, so handler must process both new and existing bookings each invocation to avoid missing reminder windows. [Source: architecture/brownfield-architecture.md#Current Execution Flow]

### Project Structure Notes

- Architecture expects `database/session_manager.py`, but the current implementation places `SessionManager` in `src/auth/session_manager.py`; plan for reconciliation when wiring dependencies so modules remain discoverable. [Source: architecture/brownfield-architecture.md#Enhancement Impact Analysis]

### Testing

- **Test File Location:** `tests/e2e/test_lambda_handler.py` (new) plus updated coverage configuration. [Source: architecture/brownfield-architecture.md#Recommended Test Strategy]  
- **Execution Examples:** `pytest tests/e2e/test_lambda_handler.py -v` (smoke), `pytest tests --cov=src/main.py --cov-report=term-missing` (coverage gate ≥80%). [Source: architecture/brownfield-architecture.md#Testing Reality]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Story drafted from Epic 4 requirements | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used
_To be populated by the development agent._

### Debug Log References
_To be populated by the development agent._

### Completion Notes List
_To be populated by the development agent._

### File List
_To be populated by the development agent._

---

## QA Results

_To be populated by the QA agent._
