# Story 2.3: Extract DynamoDB Operations

**Status:** Draft

---

## Story

**As a** developer,
**I want** to move all DynamoDB interactions into a dedicated database module,
**so that** booking/session persistence logic becomes testable and reusable across the refactored system.

---

## Acceptance Criteria

**Functional Requirements**
1. `src/database/dynamodb_client.py` exposes a `BookingRepository` with methods `get_booking(prefix, phone)`, `create_booking(record)`, `update_flag(prefix, phone, flag_name, value)`, and `scan_unnotified_options()` that replicate the behavior of `get_item`, `sms_table.put_item`, `update_item`, and `reservation_not_confirm` in `original_code/lambda_function.py:40-205`.
2. `SessionRepository` (same module or separate) handles `get_session()`, `save_session(cookies_json)`, and `delete_session()` equivalent to `session_get_db` and `session_upsert_db`, targeting the `session` table.
3. Table names, indexes, and AWS region values are provided via configuration loader (Story 1.4/1.5) instead of hardcoded literals; default retry/backoff strategy added for throttling.
4. Repository methods return domain objects (dataclasses in `src/domain/booking.py` / `src/domain/session.py`) or dictionaries matching legacy shape, and raise custom exceptions on unrecoverable errors while preserving original error handling semantics (e.g., returning `None` when booking not found).
5. Option scan logic preserves sorting/grouping to produce start/end windows exactly as legacy implementation (`reservation_not_confirm`), verified via regression fixture.

**Integration Requirements**
6. Module accepts an injected `boto3` resource/client to enable dependency injection for tests and future local DynamoDB usage; default constructor builds resource using AWS credentials from config.
7. Logging switched to structured logger with masked phone numbers and includes latency metrics for DynamoDB operations.
8. Unit tests (with `moto` or `localstack`) cover each repository method, including success paths, missing items, and error handling; integration test demonstrates compatibility with actual AWS table schema (smoke test script documented).

**Quality Requirements**
9. Documentation (`docs/database/dynamodb.md`) describes table schemas, expected attributes, and how to run local DynamoDB for tests.
10. Migration checklist updated to track when legacy Lambda function stops calling boto3 directly (link to Epic 2 change log).
11. Static analysis and mypy (if enabled) run clean; repository type hints align with domain models.

---

## Tasks / Subtasks

- [ ] Implement booking repository (AC: 1, 4, 5, 6)
  - [ ] Port logic from legacy code
  - [ ] Add domain models and type hints
- [ ] Implement session repository (AC: 2, 3)
  - [ ] Configure Secrets/Settings integration
- [ ] Add logging and error handling (AC: 7)
- [ ] Write tests and fixtures (AC: 8)
  - [ ] Unit tests with moto/localstack
  - [ ] Regression fixture comparing legacy output
- [ ] Update documentation and checklists (AC: 9, 10, 11)

---

## Dev Notes

- **References:** Legacy implementation (`original_code/lambda_function.py:18-205`), architecture module plan (`docs/brownfield-architecture.md:900-970`), DynamoDB testing guidance (`docs/brownfield-architecture.md:1660-1675`).
- **Implementation Tips:** Use conditional updates to avoid race conditions, consider implementing helper for partition/sort key formatting, and ensure TTL/default indexes unchanged.
- **Testing Guidance:** For regression, execute legacy script against canned DynamoDB JSON fixtures and compare to new repository outputs; record results in `VALIDATION.md`.

---

## Definition of Done

- [ ] Functional and integration requirements satisfied  
- [ ] Tests pass with coverage reported (>70% for repository module)  
- [ ] Documentation and checklists updated  
- [ ] Validation evidence captured

---

## Risk and Compatibility Check

- **Primary Risk:** Data mismatches or lost flags causing duplicate/ missing SMS sends.
- **Mitigation:** Regression fixtures, read-after-write tests, and staging verification before production deploy.
- **Rollback:** Revert Lambda to use legacy helper functions; keep old code path available behind feature flag during rollout.

**Compatibility Verification**
- [x] API for downstream rule engine actions remains stable  
- [x] Works with Secrets Manager configuration  
- [x] Supports future schema extensions (additional flags/fields)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | 1.0 | Story drafted from Epic 2 requirements | Sarah (PO) |

