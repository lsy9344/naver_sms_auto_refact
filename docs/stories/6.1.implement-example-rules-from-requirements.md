# Story 6.1: Implement Example Rules from Requirements

**Status:** Draft *(blocked on Stories 6.2, 6.3, 6.4)*

---

## Quick Project Assessment

**Current System Context**
- [x] Rule engine automation is externalized via `config/rules.yaml` with condition/action registries implemented in `src/rules/engine.py` within the modular project layout. [Source: docs/brownfield-architecture.md#project-structure-actual]
- [x] SMS content and per-store metadata derive from `config/sms_templates.yaml` and `config/stores.yaml`, orchestrated by `src/notifications/sms_service.py`. [Source: docs/notifications/sms-service.md#configuration-files]
- [x] Slack delivery shares the notifications layer and relies on configuration toggles documented in the Slack integration guide. [Source: docs/testing/slack-integration.md#overview]

**Change Scope**
- [x] Encode the four canonical scenarios from the Korean requirements as configuration-driven rules without altering core engine code. [Source: docs/epics/epic-6-post-mvp-enhancements.md#example-rules-from-requiermentmd-korean-requirements]
- [x] Contain changes to configuration, fixtures, and validation coverage that prove the new rules behave as expected. [Source: docs/epics/epic-6-post-mvp-enhancements.md#epic-goals]
- [x] Demonstrate success through regression evidence that the new rules drive correct SMS and Slack outputs. [Source: docs/epics/epic-6-post-mvp-enhancements.md#success-criteria]

---

## Story

**As a** product operations manager,  
**I want** the four exemplar automation scenarios from the Korean requirements captured as YAML rules,  
**so that** we can prove the refactored rule engine handles store- and option-specific messaging without shipping new code.

---

## Acceptance Criteria

1. `config/rules.yaml` defines an enabled “Expert Correction Slack Digest” rule that uses `has_option_keyword` with `keywords: ["전문가 보정"]` and dispatches `send_slack` with an explicit `channel` and `message` referencing the `expert_correction_digest` payload stored in `config/slack_templates.yaml`. The Slack message must list each booking’s name, masked phone number, and append the `pro_edit_count` in parentheses. [Source: docs/epics/epic-6-post-mvp-enhancements.md#example-rules-from-requiermentmd-korean-requirements] [Source: docs/testing/slack-integration.md#configuration]
2. Slack digest copy for `expert_correction_digest` is captured with operations-approved Korean wording and multiline block formatting inside `config/slack_templates.yaml`, and regression assertions in `tests/integration/test_slack_integration.py` verify the masked roster plus count renders correctly. [Source: docs/testing/slack-integration.md#message-formatting] [Source: docs/testing/rule-engine-tests.md#test-organization]
3. “Holiday Event Customer List” rule uses `date_range` with `start_date`/`end_date` parameters and the `has_multiple_options` evaluator together with `send_slack` to emit templated booking summaries to the configured marketing channel, satisfying Requirement Example 4 and reusing the Slack integration delivered in Story 6.2. [Source: docs/epics/epic-6-post-mvp-enhancements.md#example-rules-from-requiermentmd-korean-requirements] [Source: docs/testing/slack-integration.md#configuration]
4. Regression coverage demonstrates the new rules trigger expected SMS/Slack side effects without altering legacy behaviors by extending rule engine integration tests and booking fixtures to cover the new scenarios. [Source: docs/testing/rule-engine-tests.md#test-organization] [Source: docs/epics/epic-6-post-mvp-enhancements.md#testing-strategy-for-this-epic]
5. Business-facing documentation in `docs/epics/epic-6-post-mvp-enhancements.md#business-user-rule-management-guide` explains how to enable, tune, or disable the example rules (conditions, templates, channels) so operations can manage them independently. [Source: docs/epics/epic-6-post-mvp-enhancements.md#business-user-rule-management-guide]

---

## Tasks / Subtasks

- [ ] Task 1: Finalize Slack digest payload (AC: 1, 2)  
  - [ ] Capture operations-approved “전문가 보정” digest text with `{{booking.name}}`, `{{booking.phone_masked}}`, and `{{booking.pro_edit_count}}` in `config/slack_templates.yaml` under the `expert_correction_digest` key using multiline formatting. [Source: docs/testing/slack-integration.md#message-formatting]  
  - [ ] Ensure fixtures and rule context expose `pro_edit_count` (or equivalent) so the Slack template renders accurate counts. [Source: src/domain/booking.py]  
  - [ ] Extend Slack integration fixtures (`tests/fixtures/` as needed) and documentation to reflect the digest output format for operator validation. [Source: docs/testing/slack-integration.md#configuration]

- [ ] Task 2: Encode new rules in configuration (AC: 1, 3)  
  - [ ] Append “Expert Correction Slack Digest” to `config/rules.yaml` with the revised `has_option_keyword` filter (`["전문가 보정"]`) and the `send_slack` action referencing `expert_correction_digest` with an explicit channel delivered by Story 6.2. [Source: docs/brownfield-architecture.md#project-structure-actual]  
  - [ ] Add “Holiday Event Customer List” rule that references the delivered `date_range` (using `start_date`/`end_date`), `has_multiple_options`, and `send_slack`, including channel and message parameters. [Source: docs/epics/epic-6-post-mvp-enhancements.md#example-rules-from-requiermentmd-korean-requirements]  
  - [ ] Update rule comments/metadata so future operators understand which requirement scenario each rule satisfies. [Source: docs/epics/epic-6-post-mvp-enhancements.md#business-user-rule-management-guide]

- [ ] Task 3: Strengthen automated coverage (AC: 2, 4)  
  - [ ] Add integration tests that execute the new rules end-to-end, asserting the expert correction Slack digest and the holiday list Slack payload both emit as expected (`tests/integration/test_slack_integration.py`, `tests/integration/test_rules_regression.py`). [Source: docs/testing/rule-engine-tests.md#test-organization]  
  - [ ] Refresh regression fixtures to include bookings that meet and fail the new conditions, guarding against false positives. [Source: docs/epics/epic-6-post-mvp-enhancements.md#testing-strategy-for-this-epic]  
  - [ ] Ensure CI executes the augmented suites and fails on parity deltas. [Source: docs/testing/rule-engine-tests.md#ci-cd-integration]

- [ ] Task 4: Publish operator guidance (AC: 5)  
  - [ ] Document rule parameters, digest template names, and Slack channel expectations in `docs/epics/epic-6-post-mvp-enhancements.md#business-user-rule-management-guide` so business users can adjust them. [Source: docs/epics/epic-6-post-mvp-enhancements.md#business-user-rule-management-guide]  
  - [ ] Include enable/disable walkthroughs and testing steps to validate rule changes before production, referencing the toggle instructions added in Story 6.2. [Source: docs/epics/epic-6-post-mvp-enhancements.md#business-user-rule-management-guide]

---

## Dev Notes

- **Story Dependencies:** Slack executor (Story 6.2) and the new `date_range` / `has_multiple_options` condition evaluators (Stories 6.3 & 6.4) must be available before these rules activate; do not begin implementation until those stories are marked Done. [Source: docs/epics/epic-6-post-mvp-enhancements.md#epic-dependencies]
- **Configuration Locations:** Update `config/rules.yaml`, Slack notification documentation, and supporting fixtures; do not modify engine code unless defects surface. [Source: docs/brownfield-architecture.md#project-structure-actual]
- **Template Handling:** Capture the digest text with the same multiline scalar formatting used elsewhere so Slack payload comparisons remain deterministic. [Source: docs/testing/slack-integration.md#message-formatting]
- **Rule Context:** Ensure fixtures set `booking.option_keywords` (or flags such as `has_pro_edit_option`/`pro_edit_count`) so `has_option_keyword` and the Slack template both resolve correctly. [Source: src/domain/booking.py] [Source: docs/epics/epic-6-post-mvp-enhancements.md#example-rules-from-requiermentmd-korean-requirements]
- **Slack Messaging:** Use the channel constants and enablement flags defined in the Slack integration guide; payloads should mask PII per existing helpers while surfacing the pro edit counts. [Source: docs/testing/slack-integration.md#configuration]
- **Regression Harness:** Extend comparison/regression suites rather than adding bespoke scripts to keep parity evidence centralized. [Source: docs/testing/rule-engine-tests.md#test-organization]

### Testing

- `pytest tests/integration/test_slack_integration.py -k "expert_correction_digest" -v` (validate new digest payload once Slack executor is available). [Source: docs/testing/rule-engine-tests.md#test-organization]
- `pytest tests/integration/test_rules_regression.py -k "holiday_event" -v` (end-to-end rule verification after new evaluators land). [Source: docs/testing/rule-engine-tests.md#test-organization]
- `pytest tests -m integration --cov=src/rules --cov-report=term-missing` (ensure coverage remains ≥80% after rule additions). [Source: docs/testing/rule-engine-tests.md#ci-cd-integration]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-22 | 1.0 | Initial draft capturing requirement-driven example rules | Sarah (Product Owner) |

---

## Dev Agent Record

_Populated during implementation._

---

## QA Results

_Reserved for QA review._
