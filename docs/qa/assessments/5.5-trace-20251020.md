# Requirements Traceability Matrix

## Story: 5.5 - Validate New Lambda Readiness

**Date**: 2025-10-20  
**Reviewer**: Quinn (Test Architect)

---

## Coverage Summary

- **Total Requirements**: 9 Acceptance Criteria
- **Fully Covered**: 4 (44%)
- **Partially Covered**: 4 (44%)
- **Not Covered**: 1 (12%)

### Coverage by Category

| Category | Total | Full | Partial | None | Risk |
|----------|-------|------|---------|------|------|
| Functional Requirements | 3 | 1 | 2 | 0 | High |
| Integration Requirements | 3 | 1 | 2 | 0 | High |
| Quality Requirements | 3 | 2 | 1 | 1 | Medium |

---

## Detailed Requirement Mappings

### AC1: Automated Regression Suite with 100% Parity

**Status**: PARTIALLY COVERED

**Requirement**:
- Automated regression suite, comparison replays, and targeted manual dry-runs complete successfully
- 100% parity across SMS, DynamoDB, Telegram, and Slack webhook outputs
- Any discrepancies documented with root-cause notes and resolved prior to sign-off

**Test Coverage**:

| Test File | Test Case | Coverage | Given-When-Then |
|-----------|-----------|----------|-----------------|
| tests/comparison/test_output_parity.py | TestOutputParity (8 parameterized methods) | Partial | Given: Golden dataset fixtures (6 scenarios: new_booking, two_hour, option, cookie, empty, volume) When: Regression suite runs comparisons When: New Lambda processes SMS/DynamoDB/Telegram Then: Output matched against legacy baseline with 80%+ pass rate |
| tests/comparison/test_output_parity.py | test_comprehensive_fixture_coverage | Unit | Given: All 6 scenario types in fixtures When: Tested in single run Then: All scenarios execute; aggregate pass rate ≥80% |
| tests/unit/test_comparison_monitoring.py | TestCompareSMSPayloads (5 tests) | Partial | Given: SMS payload pairs When: Compared via compare_sms_payloads() Then: Character-by-character diff, critical field detection |
| tests/unit/test_comparison_monitoring.py | TestCompareDBRecords (4 tests) | Partial | Given: DynamoDB record pairs When: Compared via compare_db_records() Then: Field-by-field mismatch detected |
| tests/unit/test_comparison_monitoring.py | TestComparisonLogger (3 tests) | Unit | Given: Comparison results When: Logged to JSON When: Published to CloudWatch Then: Structured logs with run_id, metrics |

**Coverage Gaps**:
- ❌ No integration test validating entire regression suite pipeline (bootstrap → run → publish → report)
- ❌ No test for "root-cause notes and resolved" - remediation workflow not tested
- ❌ No test validating 100% parity explicitly required (currently 80% threshold)
- ❌ No test for Slack webhook payload comparison in automation (manual only)
- ❌ No performance test for large bookings (100+) at scale

**Severity**: HIGH - This is core functionality for go/no-go decision

---

### AC2: Comparison Artifacts Generated with Timestamps

**Status**: PARTIALLY COVERED

**Requirement**:
- Comparison artifacts (JSON + markdown) generated for each validation batch
- Archived with timestamps for auditability
- Including Slack webhook payloads and delivery confirmation logs

**Test Coverage**:

| Test File | Test Case | Coverage | Given-When-Then |
|-----------|-----------|----------|-----------------|
| tests/comparison/test_output_parity.py | Test fixtures generate JSON + markdown | Partial | Given: Comparison batch completed When: DiffReporter.generate_reports() called Then: JSON (metadata + mismatches) + Markdown (summaries + categorization) files created |
| tests/comparison/diff_reporter.py (code review) | DiffReporter class | Unit | Given: ComparisonMismatch list When: Report generated Then: Files written with UTF-8, emoji formatting in markdown |

**Coverage Gaps**:
- ❌ No test validating JSON schema validity (could be malformed JSON)
- ❌ No test for timestamp accuracy/monotonicity across batches
- ❌ No test for Slack webhook payload comparison in artifacts
- ❌ No test for "delivery confirmation logs" - not clear if implemented
- ❌ No test for artifact archival mechanics (how are they versioned/stored?)
- ❌ No test for disk space handling (full filesystem scenario)
- ❌ No test for concurrent batch writes (thread safety)

**Severity**: MEDIUM - Artifacts exist but audit trail completeness uncertain

---

### AC3: Aggregated Validation Summary

**Status**: PARTIALLY COVERED

**Requirement**:
- Aggregated validation summary highlighting match percentage, error counts, performance trends
- Separate metrics for SMS, Telegram, and Slack notification delivery success rates

**Test Coverage**:

| Test File | Test Case | Coverage | Given-When-Then |
|-----------|-----------|----------|-----------------|
| tests/unit/test_comparison_monitoring.py | TestComparisonSummary (3 tests) | Unit | Given: Individual comparison results When: ComparisonSummary aggregated (100%, partial, zero) Then: Match percentage, error counts calculated |
| tests/comparison/test_output_parity.py (code review) | Aggregate summary in diff reporter | Partial | Given: All scenario comparisons complete When: Aggregate summary created Then: Overall pass rate, categorized mismatch count provided |

**Coverage Gaps**:
- ❌ No test validating "separate metrics for SMS, Telegram, AND Slack" - Slack metrics not explicitly tested
- ❌ No test for performance trend analysis over multiple validation runs
- ❌ No test for summary completeness validation (all channels represented)
- ❌ No test for accuracy of separate channel metrics
- ❌ No integration test showing summary generated from actual campaign

**Severity**: MEDIUM - Slack metrics coverage unclear

---

### AC4: CloudWatch Dashboard Evidence

**Status**: FULLY COVERED

**Requirement**:
- CloudWatch dashboards capture validation metrics at beginning and end of campaign
- Exported evidence attached to story record
- Including Slack delivery success metrics

**Test Coverage**:

| Test File | Test Case | Coverage | Given-When-Then |
|-----------|-----------|----------|-----------------|
| infrastructure/terraform/modules/cloudwatch/ | Dashboard widgets (rows 18-24) | Integration | Given: Comparison Lambda runs When: Metrics published to `naver-sms/comparison` namespace Then: CloudWatch dashboard displays 6 metric widgets (sms_sent_old/new, match_pct, discrepancies, errors, duration) |
| tests/unit/test_comparison_monitoring.py | TestComparisonMetricsPublisher (4 tests) | Unit | Given: Comparison results When: publish_metrics() called Then: AWS CloudWatch put_metric_data() invoked with correct dimensions |
| docs/ops/cloudwatch-queries.md | 10 saved queries documented | Documentation | Given: Campaign running When: CloudWatch Logs Insights queried Then: Queries return SMS/DB/Telegram/Slack comparison metrics |

**Coverage Status**: ✅ FULL

---

### AC5: Alarm Triage and SLA Compliance

**Status**: PARTIALLY COVERED

**Requirement**:
- Any comparison-related alarms triggered during testing triaged within SLA
- Outcome notes captured for each incident
- Slack webhook delivery failures trigger immediate escalation

**Test Coverage**:

| Test File | Test Case | Coverage | Given-When-Then |
|-----------|-----------|----------|-----------------|
| infrastructure/terraform/modules/cloudwatch/ | 3 comparison alarms defined | Integration | Given: Threshold breached (discrepancies > 0, match_pct < 100, any_discrepancies) When: Alarm triggers Then: SNS routes to Slack/Telegram webhooks |
| tests/integration/test_failure_scenarios.py (from codebase exploration) | Alarm simulation | Integration | Given: Alarm rule triggered When: Testing alarm path Then: Notification sent within SLA window |

**Coverage Gaps**:
- ❌ No test for <15 minute SLA validation on triage response
- ❌ No test for "outcome notes captured" mechanism - where/how documented?
- ❌ No test for Slack webhook delivery failure escalation specifically
- ❌ No test for alarm acknowledgment workflow
- ❌ No load test showing alarm triggers don't overwhelm notification system

**Severity**: MEDIUM - Alarm response critical but SLA verification missing

---

### AC6: Validation Evidence Package

**Status**: PARTIALLY COVERED

**Requirement**:
- Validation evidence (test reports, metrics exports, alarm states, approvals) appended to VALIDATION.md
- Linked for readiness review
- Including Slack webhook configuration and test results

**Test Coverage**:

| Test File | Test Case | Coverage | Given-When-Then |
|-----------|-----------|----------|-----------------|
| docs/VALIDATION.md | Story 5.5 section | Manual | Given: Campaign complete When: Evidence compiled Then: Test reports, metrics, alarm transcripts, Slack results documented |
| (No automated test) | - | None | - |

**Coverage Gaps**:
- ❌ No automated test validating VALIDATION.md completeness
- ❌ No test verifying all required sections present (test reports, metrics, alarms, approvals)
- ❌ No test validating Slack webhook configuration is documented
- ❌ No test for link validity/non-orphaned references
- ❌ No automated packaging of evidence artifacts

**Severity**: HIGH - Manual process prone to incompleteness

---

### AC7: Updated Operational Runbook

**Status**: FULLY COVERED

**Requirement**:
- `docs/ops/runbook.md` includes updated validation playbook
- Describing regression steps, alarm monitoring, Slack webhook delivery procedures, discrepancy escalation paths

**Test Coverage**:

| Test File | Test Case | Coverage | Given-When-Then |
|-----------|-----------|----------|-----------------|
| docs/ops/runbook.md | Validation campaign section | Documentation | Given: Runbook exists When: Validation procedures reviewed Then: Regression steps, alarm monitoring, Slack procedures documented |
| docs/ops/cloudwatch-queries.md | Saved queries section | Documentation | Given: Campaign running When: Operator consults runbook Then: Queries, thresholds, escalation paths provided |

**Coverage Status**: ✅ FULL

---

### AC8: Deviation Investigation & Discrepancy Remediation

**Status**: PARTIALLY COVERED

**Requirement**:
- Every deviation/discrepancy receives completed diff reporter package
- Remediation summary before validation closes
- Slack notification delivery issues logged separately for investigation

**Test Coverage**:

| Test File | Test Case | Coverage | Given-When-Then |
|-----------|-----------|----------|-----------------|
| tests/comparison/diff_reporter.py | DiffReporter mismatch categorization | Partial | Given: Comparison finds mismatch When: Diff reporter processes When: Report categorizes by severity (critical, warning) Then: JSON + Markdown package generated |
| tests/unit/test_comparison_monitoring.py | ComparisonMismatch dataclass | Unit | Given: SMS/DB mismatch detected When: Mismatch recorded When: Reporter invoked Then: 7-field mismatch artifact created (category, field, values, severity, message) |

**Coverage Gaps**:
- ❌ No test for complete remediation workflow (detect → investigate → fix → re-validate)
- ❌ No test for "Slack notification delivery issues logged separately" - separate tracking unclear
- ❌ No test validating discrepancy package completeness before sign-off
- ❌ No test for remediation summary format/completeness
- ❌ No integration test showing end-to-end investigation cycle

**Severity**: HIGH - Remediation process not fully tested

---

### AC9: Final Readiness Report

**Status**: NOT COVERED

**Requirement**:
- Final readiness report aligns validation outcomes with PRD's functional parity success criteria
- Confirms MSC1 is satisfied prior to cutover approval
- Explicitly notes Slack webhook integration status and 100% payload parity

**Test Coverage**:

| Test File | Test Case | Coverage | Given-When-Then |
|-----------|-----------|----------|-----------------|
| (No test found) | - | None | - |

**Coverage Gaps**:
- ❌ No automated readiness report generation
- ❌ No test validating alignment with PRD success criteria
- ❌ No test confirming MSC1 satisfaction (100% parity, all channels working)
- ❌ No test validating Slack webhook status explicitly reported
- ❌ No automated go/no-go decision validation
- ❌ No test for sign-off checklist automation

**Severity**: CRITICAL - This is the final gate decision point

---

## Critical Coverage Gaps Summary

### P0 - MUST FIX (Blocks go/no-go decision)

1. **End-to-end validation campaign integration test**
   - Must: Bootstrap → run full suite → publish metrics → generate reports → validate success
   - Impact: Campaign could fail at integration points not caught by unit tests

2. **Automated readiness report validation**
   - Must: Generate final report that explicitly validates:
     - 100% parity across SMS, DynamoDB, Telegram, Slack
     - MSC1 success criteria met
     - Slack webhook integration working
     - All channels tested
   - Impact: Go/no-go decision currently manual

3. **Slack webhook integration in automation**
   - Must: Test that Slack webhooks receive payloads during comparison
   - Must: Validate payload format matches expectations
   - Must: Test Slack delivery failure scenarios
   - Impact: Slack metrics may not actually be collected

4. **Remediation workflow testing**
   - Must: Test complete cycle: detect mismatch → investigate → fix → re-validate → close
   - Impact: How remediation is tracked/verified is unclear

### P1 - SHOULD FIX (Improves confidence)

5. **Bootstrap script automated tests**
   - Add: Unit tests for prerequisite validation, directory setup, metadata generation
   - Add: Integration test with actual Slack webhook verification
   - Impact: Script errors only caught at runtime

6. **CloudWatch integration test**
   - Add: Publish real metrics and verify they appear in CloudWatch
   - Add: Verify alarms trigger on thresholds
   - Add: Verify dashboard widgets render correctly
   - Impact: Metrics/alarms might not work in production

7. **Performance at scale**
   - Add: Test validation campaign with 100+ bookings
   - Add: Verify CloudWatch metric publishing throughput
   - Add: Verify memory usage under load
   - Impact: Campaign might timeout on large workloads

8. **Campaign success criteria automation**
   - Add: Automated validation of:
     - 7-day window completion
     - 100% match percentage achieved
     - Zero critical mismatches
     - No SMS sent to production
   - Impact: Sign-off decision requires complete manual review

---

## Risk Assessment by Coverage Type

| Coverage Type | Count | Risk Level |
|---------------|-------|-----------|
| Full (automated) | 2 ACs | Low |
| Partial (mixed) | 6 ACs | Medium-High |
| None (manual) | 1 AC | Critical |

---

## Non-Functional Requirements Traceability

### Security (NFR)

**Requirement**: Comparison mode prevents production SMS

| Test | Coverage | Status |
|------|----------|--------|
| COMPARISON_MODE kill switch validation | Partial | ⚠️ No explicit test that mode prevents SMS |
| PII masking enforcement | Full | ✅ Tests in test_output_parity.py |
| Secrets Manager access validation | Partial | ⚠️ Bootstrap checks but not tested |

### Performance (NFR)

**Requirement**: Campaign completes within acceptable time

| Test | Coverage | Status |
|------|----------|--------|
| 4-minute Lambda execution threshold | Partial | ⚠️ Configured but not validated under load |
| CloudWatch metric publishing latency | Partial | ⚠️ Unit tested but not E2E |
| Slack notification delivery SLA | Partial | ⚠️ No timing test for 15-min SLA |

### Reliability (NFR)

**Requirement**: Campaign resilient to transient failures

| Test | Coverage | Status |
|------|----------|--------|
| Slack webhook retry logic (3 attempts) | Unit tested | ✅ |
| Rate limiting (429) handling | Unit tested | ✅ |
| Partial campaign recovery | None | ❌ Not tested |
| Single booking failure isolation | Partial | ⚠️ Not clear if campaign continues |

### Maintainability (NFR)

**Requirement**: Campaign procedures documented and repeatable

| Test | Coverage | Status |
|------|----------|--------|
| Runbook completeness | Documentation | ✅ Documented |
| Automated bootstrap | Partial | ⚠️ Script exists, no tests |
| CloudWatch queries documented | Documentation | ✅ 10 queries in runbook |
| Campaign audit trail | Partial | ⚠️ run_id exists, versioning unclear |

---

## Recommendations

### Immediate Actions (Before Story Sign-Off)

1. **Create integration test** (`tests/integration/test_validation_campaign.py`)
   - Execute full bootstrap → comparison → reporting workflow
   - Validate all outputs and success criteria
   - Priority: **CRITICAL**

2. **Add automated readiness validator** (`tests/integration/test_readiness_gate.py`)
   - Validate 100% parity across all channels
   - Confirm MSC1 success criteria
   - Generate automated go/no-go recommendation
   - Priority: **CRITICAL**

3. **Test Slack webhook integration** (add to `tests/comparison/test_output_parity.py`)
   - Mock Slack responses during comparison
   - Validate webhook payloads sent correctly
   - Test failure scenarios
   - Priority: **HIGH**

4. **Document remediation workflow** (`docs/ops/remediation-procedures.md`)
   - Define how mismatches are investigated
   - Define how fixes are validated
   - Define sign-off criteria
   - Priority: **HIGH**

### Follow-Up Actions (Next Sprint)

5. Create bootstrap script unit tests
6. Add CloudWatch integration tests
7. Implement campaign-scale performance tests
8. Automate evidence packaging into VALIDATION.md

---

## Trace Matrix Summary

```
Total Requirements: 9 ACs

Coverage Breakdown:
  ✅ FULL:     2 ACs (22%) - AC4, AC7
  ⚠️ PARTIAL:  6 ACs (66%) - AC1, AC2, AC3, AC5, AC6, AC8
  ❌ NONE:     1 AC  (12%) - AC9

Priority by Risk:
  🔴 CRITICAL: 1 AC  (AC9 - Readiness Report)
  🟠 HIGH:     3 ACs (AC1, AC8, AC6)
  🟡 MEDIUM:   5 ACs (AC2, AC3, AC5)
```

---

**Report Generated**: 2025-10-20  
**Test Architect**: Quinn  
**Next Review**: After integration tests implemented
